<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anlagen-Übersicht Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8fafc;
      box-sizing: border-box;
    }
    
    body {
      min-height: 100vh;
      overflow: hidden;
    }
    
    /* Split View Container */
    .split-view-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    
    /* Left Panel - Anlagen-Übersicht */
    .split-left-panel {
      flex: 0 0 40%;
      min-width: 400px;
      max-width: 60%;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e5e7eb;
      background: #f8fafc;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .split-left-panel.collapsed {
      flex: 0 0 50px;
      min-width: 50px;
      max-width: 50px;
    }
    
    /* Fixed Header im Left Panel */
    .panel-header-fixed {
      flex: 0 0 auto;
      background: #f1f5f9;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px;
      position: relative;
    }
    
    .panel-toggle-btn {
      position: absolute;
      top: 15px;
      right: -15px;
      width: 30px;
      height: 30px;
      background: #3b82f6;
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .panel-toggle-btn:hover {
      background: #2563eb;
      transform: scale(1.1);
    }
    
    .collapsed .panel-header-fixed {
      padding: 8px;
    }
    
    .collapsed .panel-header-fixed .panel-title,
    .collapsed .panel-header-fixed .overview-controls {
      display: none;
    }
    
    .collapsed .panel-content-scrollable {
      display: none;
    }
    
    .panel-collapsed-icon {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .panel-collapsed-icon:hover {
      color: #3b82f6;
    }
    
    .collapsed .panel-collapsed-icon {
      display: flex;
    }
    
    .panel-collapsed-icon i {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .panel-collapsed-icon span {
      font-size: 10px;
      writing-mode: vertical-lr;
      text-orientation: mixed;
      font-weight: 500;
    }
    
    /* Panel Toggle Tooltip */
    .panel-toggle-tooltip {
      position: absolute;
      left: 40px;
      top: 50%;
      transform: translateY(-50%);
      background: #1f2937;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1002;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .panel-toggle-btn:hover .panel-toggle-tooltip {
      opacity: 1;
      visibility: visible;
    }
    
    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .panel-title h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .overview-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      white-space: nowrap;
    }
    
    .toggle-all-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .toggle-all-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .toggle-all-btn.active {
      background: #ffcccb;
      border-color: #ff6b6b;
      color: #c92a2a;
    }
    
    .toggle-all-btn.active:hover {
      background: #ffb3b3;
      border-color: #ff5252;
    }
    
    .temp-analysis-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 15px 0;
      padding: 15px;
      display: none;
    }
    
    .temp-analysis-container.active {
      display: block;
    }
    
    .temp-analysis-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .temp-analysis-title {
      font-size: 16px;
      font-weight: 600;
      color: #495057;
      margin: 0;
    }
    
    .temp-analysis-close {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .temp-analysis-close:hover {
      background: #e9ecef;
      color: #495057;
    }
    
    .info-btn {
      background: #3b82f6;
      border: 1px solid #2563eb;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    
    .info-btn:hover {
      background: #2563eb;
      border-color: #1d4ed8;
      transform: translateY(-1px);
    }
    
    .info-btn.active {
      background: #059669;
      border-color: #047857;
      color: white;
    }
    
    .info-btn.active:hover {
      background: #047857;
      border-color: #065f46;
    }
    
    /* Scrollable Content */
    .panel-content-scrollable {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .panel-content-scrollable::-webkit-scrollbar {
      width: 6px;
    }
    
    .panel-content-scrollable::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    .panel-content-scrollable::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .panel-content-scrollable::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Category Tables */
    .category-tables {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .category-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .category-section.collapsed .category-content {
      max-height: 0;
      overflow: hidden;
    }
    
    .category-section.expanded .category-content {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #374151;
      cursor: pointer;
      border-bottom: 1px solid #1f2937;
      border-radius: 8px 8px 0 0;
    }
    
    .category-header:hover {
      background: #4b5563;
    }
    
    /* Kritische Anlagen - helles rot */
    .category-section[data-category="critical"] .category-header {
      background: #fecaca;
      border-bottom: 1px solid #f87171;
    }
    
    .category-section[data-category="critical"] .category-header:hover {
      background: #fca5a5;
    }
    
    /* Anlagen mit Warnungen - helles orange */
    .category-section[data-category="warnings"] .category-header {
      background: #fed7aa;
      border-bottom: 1px solid #fb923c;
    }
    
    .category-section[data-category="warnings"] .category-header:hover {
      background: #fdba74;
    }
    
    /* Offline-Anlagen - zwischen helles und normales grau */
    .category-section[data-category="offline"] .category-header {
      background: #d1d5db;
      border-bottom: 1px solid #9ca3af;
    }
    
    .category-section[data-category="offline"] .category-header:hover {
      background: #9ca3af;
    }
    
    /* Anlagen - hoher Energieverbrauch - normales grau */
    .category-section[data-category="high-consumption"] .category-header {
      background: #6b7280;
      border-bottom: 1px solid #4b5563;
    }
    
    .category-section[data-category="high-consumption"] .category-header:hover {
      background: #4b5563;
    }
    
    /* Optimierte Anlagen - helles grün */
    .category-section[data-category="optimized"] .category-header {
      background: #bbf7d0;
      border-bottom: 1px solid #86efac;
    }
    
    .category-section[data-category="optimized"] .category-header:hover {
      background: #a7f3d0;
    }
    
    .expand-btn {
      background: none;
      border: none;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color 0.2s;
    }
    
    .expand-btn:hover {
      color: #f3f4f6;
    }
    
    /* Text-Farben für hellere Hintergründe */
    .category-section[data-category="critical"] .expand-btn,
    .category-section[data-category="warnings"] .expand-btn,
    .category-section[data-category="offline"] .expand-btn,
    .category-section[data-category="optimized"] .expand-btn {
      color: #1f2937;
    }
    
    .category-section[data-category="critical"] .expand-btn:hover,
    .category-section[data-category="warnings"] .expand-btn:hover,
    .category-section[data-category="offline"] .expand-btn:hover,
    .category-section[data-category="optimized"] .expand-btn:hover {
      color: #374151;
    }
    
    /* Hoher Energieverbrauch behält weißen Text */
    .category-section[data-category="high-consumption"] .expand-btn {
      color: #ffffff;
    }
    
    .category-section[data-category="high-consumption"] .expand-btn:hover {
      color: #f3f4f6;
    }
    
    .expand-btn i {
      font-size: 12px;
    }
    
    .category-summary {
      font-size: 12px;
      color: #d1d5db;
      font-style: italic;
    }
    
    /* Summary-Text-Farben für hellere Hintergründe */
    .category-section[data-category="critical"] .category-summary,
    .category-section[data-category="warnings"] .category-summary,
    .category-section[data-category="offline"] .category-summary,
    .category-section[data-category="optimized"] .category-summary {
      color: #4b5563;
    }
    
    /* Hoher Energieverbrauch behält hellen Summary-Text */
    .category-section[data-category="high-consumption"] .category-summary {
      color: #d1d5db;
    }
    
    .category-content {
      transition: max-height 0.3s ease;
      max-height: 0;
      overflow: hidden;
    }
    
    .category-section.expanded .category-content {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      position: relative;
    }
    
    .category-section.expanded .category-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .category-section.expanded .category-content::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    .category-section.expanded .category-content::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .category-section.expanded .category-content::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Scrollbar für eingebettete Tabellen */
    .category-content div::-webkit-scrollbar {
      width: 8px;
    }
    
    .category-content div::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    .category-content div::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .category-content div::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .category-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
      background: #fff3cd;
      border: 1px solid #f0ad4e;
    }
    
    /* Warnungen-Tabelle - gleiche Styles wie kritische Anlagen */
    .category-section[data-category="warnings"] .category-table {
      background: #fff3cd;
      border: 1px solid #f0ad4e;
    }
    
    /* Spaltenbreiten für Temperatur-Analyse-Tabelle */
    .category-table th:nth-child(1),
    .category-table td:nth-child(1) {
      width: 20%; /* ObjectName */
    }
    
    .category-table th:nth-child(2),
    .category-table td:nth-child(2) {
      width: 50%; /* Temperatur-Analyse */
    }
    
    .category-table th:nth-child(3),
    .category-table td:nth-child(3) {
      width: 15%; /* Status */
    }
    
    .category-table th:nth-child(4),
    .category-table td:nth-child(4) {
      width: 15%; /* Update-Zeit */
    }
    
    /* Spezielle Styles für Temperatur-Analyse */
    .category-table td:nth-child(2) {
      font-family: monospace;
      line-height: 1.2;
      padding: 3px 8px;
    }
    
    .category-table td:nth-child(1) b {
      color: #2563eb;
      font-weight: 600;
    }
    

    
    .category-table th,
    .category-table td {
      text-align: left;
      padding: 2px 5px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    /* Warnungen-Tabelle - Orange Unterstrich */
    .category-section[data-category="warnings"] .category-table td {
      border-bottom: 0.5px solid #f59e0b;
    }
    
    /* Kritische Anlagen - Roter Unterstrich */
    .category-section[data-category="critical"] .category-table td {
      border-bottom: 0.5px solid #dc2626;
    }
    
    .category-table th {
      background: #f0f0f0;
      font-weight: 600;
      color: #374151;
      font-size: 11px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 10;
      border: 1px solid #ddd;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .category-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    
    .category-table tbody tr:nth-child(odd) {
      background: #ffffff;
    }
    
    /* Warnungen-Tabelle - Orange Töne */
    .category-section[data-category="warnings"] .category-table tbody tr:nth-child(even) {
      background: #fff7ed;
    }
    
    .category-section[data-category="warnings"] .category-table tbody tr:nth-child(odd) {
      background: #ffedd5;
    }
    
    /* Kritische Anlagen - Hellrote Töne */
    .category-section[data-category="critical"] .category-table tbody tr:nth-child(even) {
      background: #fef2f2;
    }
    
    .category-section[data-category="critical"] .category-table tbody tr:nth-child(odd) {
      background: #fee2e2;
    }
    
    .category-table tbody tr:hover {
      background: #f8fafc;
      cursor: pointer;
    }
    
    .category-table tbody tr.selected {
      background: #dbeafe;
      border-left: 3px solid #3b82f6;
    }
    
    .category-table tbody tr:first-child td {
      border-top: none;
    }
    
    .category-table .object-link {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
    }
    
    .category-table .object-link:hover {
      text-decoration: underline;
    }
    
    .temp-value {
      font-weight: 600;
    }
    
    .temp-critical {
      color: #dc2626;
    }
    
    .temp-warning {
      color: #f59e0b;
    }
    
    .temp-normal {
      color: #059669;
    }
    
    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .action-btn:hover {
      background: #2563eb;
    }
    
    .count-badge {
      background: #dc2626;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    
    .count-badge.warning {
      background: #f59e0b;
    }
    
    .count-badge.success {
      background: #059669;
    }
    
    .count-badge.secondary {
      background: #6b7280;
    }
    
    .count-badge.info {
      background: #3b82f6;
    }
    
    /* Resizer */
    .split-resizer {
      width: 6px;
      background: #e5e7eb;
      cursor: col-resize;
      transition: background-color 0.2s;
      position: relative;
    }
    
    .split-resizer:hover {
      background: #3b82f6;
    }
    
    .split-resizer::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 30px;
      background: #94a3b8;
      border-radius: 1px;
    }
    
    /* Right Panel - Object Details */
    .split-right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }
    
    /* Fixed Header im Right Panel */
    .object-details-header {
      flex: 0 0 auto;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .object-details-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .object-details-title h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }
    
    .object-details-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .object-details-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .control-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .control-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    /* Fullscreen Content with Scrollbar */
    .object-details-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      background: white;
    }
    
    .object-details-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .object-details-content::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    .object-details-content::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .object-details-content::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Object Details Grid */
    .object-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      height: 100%;
      padding: 24px;
    }
    
    .detail-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .detail-section h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-item label {
      font-weight: 500;
      color: #6b7280;
      font-size: 14px;
    }
    
    .detail-item span {
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }
    
    /* Grafana Mode */
    .object-details-grid.grafana-mode .detail-section {
      display: none;
    }
    
    .object-details-grid.grafana-mode .detail-section:nth-child(4) {
      display: block;
      grid-column: 1 / -1;
    }
    
    /* JSON Mode */
    .object-details-grid.json-mode .detail-section {
      display: none;
    }
    
    .object-details-grid.json-mode .detail-section:nth-child(5) {
      display: block;
      grid-column: 1 / -1;
    }
    
    /* No Selection State */
    .no-selection-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
      text-align: center;
      padding: 24px;
    }
    
    .no-selection-state i {
      font-size: 4em;
      margin-bottom: 24px;
      color: #cbd5e1;
    }
    
    .no-selection-state h4 {
      margin: 0 0 8px 0;
      color: #374151;
      font-size: 18px;
      font-weight: 600;
    }
    
    .no-selection-state p {
      margin: 0;
      font-size: 14px;
      max-width: 300px;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .split-left-panel {
        flex: 0 0 45%;
      }
    }
    
    @media (max-width: 768px) {
      .split-view-container {
        flex-direction: column;
      }
      
      .split-left-panel {
        flex: 0 0 400px;
      }
      
      .split-resizer {
        width: 100%;
        height: 4px;
        cursor: row-resize;
      }
      
      .category-tables {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .object-details-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px;
      }
      
      .panel-content-scrollable {
        padding: 12px;
      }
      
      .category-table {
        font-size: 10px;
      }
      
      .category-table th,
      .category-table td {
        padding: 4px 6px;
      }
      
      /* Verstecke weniger wichtige Spalten auf Mobile */
      .category-table th:nth-child(5),
      .category-table td:nth-child(5),
      .category-table th:nth-child(6),
      .category-table td:nth-child(6) {
        display: none;
      }
    }
    
    .object-details-grid {
        padding: 5px !important;
    }
    .object-details-grid.grafana-mode {
        padding: 3px !important;
    }
    iframe.diaframe, iframe.grafana-iframe {
        width: 100% !important;
        box-sizing: border-box;
    }
    .detail-section iframe#grafanaIframe,
    .detail-section #grafanaIframe,
    .detail-section .grafana-iframe,
    .detail-section > div[style*="position: relative"] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box;
        display: block;
    }
    .detail-section .grafana-iframe,
    .detail-section #grafanaIframe {
        height: 100% !important;
    }
    .kpi-box.kpi-wohnungswirtschaft {
      background: #e8f6ff;
      border: 1.5px solid #38bdf8;
      border-radius: 10px;
      padding: 18px 22px;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px rgba(56, 189, 248, 0.08);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 180px;
      max-width: 340px;
    }
    .kpi-box .kpi-title {
      font-size: 1.1em;
      color: #2563eb;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .kpi-box .kpi-value {
      font-size: 2.2em;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 2px;
    }
    .kpi-box .kpi-subtext {
      font-size: 0.98em;
      color: #2563eb;
      opacity: 0.8;
    }
    .kpi-box.kpi-netzwaechteralarme {
      background: #fff5f5;
      border: 1.5px solid #dc2626;
      border-radius: 10px;
      padding: 18px 22px;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.08);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 180px;
      max-width: 340px;
    }
    .kpi-box .kpi-title {
      font-size: 1.1em;
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .kpi-box .kpi-value {
      font-size: 2.2em;
      font-weight: bold;
      color: #dc2626;
      margin-bottom: 2px;
    }
    .kpi-box .kpi-subtext {
      font-size: 0.98em;
      color: #dc2626;
      opacity: 0.8;
    }
    .kpi-box .kpi-subtext a {
      color: #dc2626;
      font-weight: 600;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="split-view-container">
    <!-- Left Panel - Anlagen-Übersicht -->
    <div class="split-left-panel" id="leftPanel">
      <!-- Fixed Header -->
      <div class="panel-header-fixed">
        <button class="panel-toggle-btn" id="panelToggleBtn">
          <i class="fas fa-chevron-left"></i>
          <div class="panel-toggle-tooltip">Panel schließen</div>
        </button>
        
        <div class="panel-title">
          <h3>
            <i class="fas fa-chart-bar"></i>
            Anlagen-Übersicht Netzwächter
          </h3>
          <div class="overview-controls">
            <button class="toggle-all-btn" id="toggleAllBtn">
              <i class="fas fa-thermometer-half"></i>
              Temperatur-Analyse
            </button>
            <button class="info-btn" id="netzwaechterInfoBtn" title="Netzwächter-Informationen">
              <i class="fas fa-info-circle"></i>
              Info
            </button>
          </div>
        </div>
      </div>
             
       <!-- Scrollable Content -->
      <div class="panel-content-scrollable">
        <div class="category-tables">
          <!-- Kritische Anlagen -->
          <div class="category-section collapsed" data-category="critical">
            <div class="category-header">
              <button class="expand-btn">
                <i class="fas fa-chevron-right"></i>
                <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Kritische Anlagen
                <span class="count-badge" id="criticalCount">0</span>
              </button>
              <div class="category-summary">Nur Critical-Objekte mit heutigem Update-Datum</div>
            </div>
            <div class="category-content">
              <div id="criticalObjectsContent">
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                  <i class="fas fa-spinner fa-spin"></i> Lade kritische Anlagen...
                </div>
              </div>
            </div>
          </div>
          
          <!-- Anlagen mit Warnungen -->
          <div class="category-section collapsed" data-category="warnings">
            <div class="category-header">
              <button class="expand-btn">
                <i class="fas fa-chevron-right"></i>
                <i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> Anlagen mit Warnungen
                <span class="count-badge warning" id="warningCount">0</span>
              </button>
              <div class="category-summary">Nur Warning-Objekte aus Temperatur-Analyse</div>
            </div>
            <div class="category-content">
              <div id="warningObjectsContent">
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                  <i class="fas fa-spinner fa-spin"></i> Lade Anlagen mit Warnungen...
                </div>
              </div>
            </div>
          </div>
          
          <!-- Offline-Anlagen -->
          <div class="category-section collapsed" data-category="offline">
            <div class="category-header">
              <button class="expand-btn">
                <i class="fas fa-chevron-right"></i>
                <i class="fas fa-wifi" style="color: #9ca3af;"></i> Offline-Anlagen
                <span class="count-badge secondary">2</span>
              </button>
              <div class="category-summary">Keine Verbindung seit >2h</div>
            </div>
            <div class="category-content">
              <table class="category-table">
                <thead>
                  <tr>
                    <th>Objekt</th>
                    <th>Gruppe</th>
                    <th>Offline seit</th>
                    <th>Grund</th>
                    <th>Letzte Daten</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="object-row" data-object="ST-002 Lagerhalle">
                    <td><a href="#" class="object-link">ST-002 Lagerhalle</a></td>
                    <td>Strawa</td>
                    <td>4h 23min</td>
                    <td>Netzwerkfehler</td>
                    <td>VL: 45.2°C</td>
                  </tr>
                  <tr class="object-row" data-object="HK-006 Werkstatt">
                    <td><a href="#" class="object-link">HK-006 Werkstatt</a></td>
                    <td>Heimkehr</td>
                    <td>2h 15min</td>
                    <td>Sensor defekt</td>
                    <td>VL: 62.1°C</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Hochverbrauch-Anlagen -->
          <div class="category-section collapsed" data-category="high-consumption">
            <div class="category-header">
              <button class="expand-btn">
                <i class="fas fa-chevron-right"></i>
                <i class="fas fa-fire" style="color: #ef4444;"></i> Anlagen - hoher Energieverbrauch
                <span class="count-badge info">3</span>
              </button>
              <div class="category-summary">Energieverbrauch >20% über Durchschnitt</div>
            </div>
            <div class="category-content">
              <table class="category-table">
                <thead>
                  <tr>
                    <th>Objekt</th>
                    <th>Gruppe</th>
                    <th>Verbrauch 24h</th>
                    <th>Durchschnitt</th>
                    <th>Abweichung</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="object-row" data-object="HK-003 Schwimmbad">
                    <td><a href="#" class="object-link">HK-003 Schwimmbad</a></td>
                    <td>Heimkehr</td>
                    <td>2,847 kWh</td>
                    <td>2,200 kWh</td>
                    <td><span class="temp-warning">+29.4%</span></td>
                  </tr>
                  <tr class="object-row" data-object="ST-003 Produktionshalle">
                    <td><a href="#" class="object-link">ST-003 Produktionshalle</a></td>
                    <td>Strawa</td>
                    <td>1,956 kWh</td>
                    <td>1,500 kWh</td>
                    <td><span class="temp-warning">+30.4%</span></td>
                  </tr>
                  <tr class="object-row" data-object="CS-003 Kantine">
                    <td><a href="#" class="object-link">CS-003 Kantine</a></td>
                    <td>Cursor</td>
                    <td>1,456 kWh</td>
                    <td>1,100 kWh</td>
                    <td><span class="temp-warning">+32.4%</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Optimierte Anlagen -->
          <div class="category-section collapsed" data-category="optimized">
            <div class="category-header">
              <button class="expand-btn">
                <i class="fas fa-chevron-right"></i>
                <i class="fas fa-check-circle" style="color: #10b981;"></i> Optimierte Anlagen
                <span class="count-badge success">7</span>
              </button>
              <div class="category-summary">Keine Warnungen, optimale Leistung</div>
            </div>
            <div class="category-content">
              <table class="category-table">
                <thead>
                  <tr>
                    <th>Objekt</th>
                    <th>Gruppe</th>
                    <th>Effizienz</th>
                    <th>Laufzeit</th>
                    <th>Wartung</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="object-row" data-object="CS-001 Serverraum">
                    <td><a href="#" class="object-link">CS-001 Serverraum</a></td>
                    <td>Cursor</td>
                    <td><span class="temp-normal">98.7%</span></td>
                    <td>23h 45min</td>
                    <td>in 45 Tagen</td>
                  </tr>
                  <tr class="object-row" data-object="HK-001 Hauptgebäude">
                    <td><a href="#" class="object-link">HK-001 Hauptgebäude</a></td>
                    <td>Heimkehr</td>
                    <td><span class="temp-normal">96.2%</span></td>
                    <td>18h 32min</td>
                    <td>in 28 Tagen</td>
                  </tr>
                  <tr class="object-row" data-object="ST-001 Bürokomplex">
                    <td><a href="#" class="object-link">ST-001 Bürokomplex</a></td>
                    <td>Strawa</td>
                    <td><span class="temp-normal">94.8%</span></td>
                    <td>16h 15min</td>
                    <td>in 52 Tagen</td>
                  </tr>
                  <tr class="object-row" data-object="HK-004 Wohnheim Block A">
                    <td><a href="#" class="object-link">HK-004 Wohnheim Block A</a></td>
                    <td>Heimkehr</td>
                    <td><span class="temp-normal">93.5%</span></td>
                    <td>19h 8min</td>
                    <td>in 34 Tagen</td>
                  </tr>
                  <tr class="object-row" data-object="CS-003 Kantine">
                    <td><a href="#" class="object-link">CS-003 Kantine</a></td>
                    <td>Cursor</td>
                    <td><span class="temp-normal">92.1%</span></td>
                    <td>12h 42min</td>
                    <td>in 67 Tagen</td>
                  </tr>
                  <tr class="object-row" data-object="HK-002 Sporthalle">
                    <td><a href="#" class="object-link">HK-002 Sporthalle</a></td>
                    <td>Heimkehr</td>
                    <td><span class="temp-normal">91.8%</span></td>
                    <td>14h 23min</td>
                    <td>in 23 Tagen</td>
                  </tr>
                  <tr class="object-row" data-object="ST-002 Lagerhalle">
                    <td><a href="#" class="object-link">ST-002 Lagerhalle</a></td>
                    <td>Strawa</td>
                    <td><span class="temp-normal">90.5%</span></td>
                    <td>11h 56min</td>
                    <td>in 41 Tagen</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Collapsed Panel Icon -->
      <div class="panel-collapsed-icon" id="panelCollapsedIcon">
        <i class="fas fa-chart-bar"></i>
        <span>Anlagen</span>
      </div>
    </div>
    
    <!-- Resizer -->
    <div class="split-resizer" id="splitResizer"></div>
    
    <!-- Right Panel - Object Details -->
    <div class="split-right-panel">
      <!-- Fixed Header -->
      <div class="object-details-header">
        <div class="object-details-title">
          <h3 id="objectDetailsTitle">
            <i class="fas fa-cube"></i>
            Objekt auswählen
          </h3>
          <div class="object-details-subtitle" id="objectDetailsSubtitle">
            Wählen Sie ein Objekt aus der Übersicht aus
          </div>
        </div>
        
        <div class="object-details-controls">
          <button class="control-btn" id="grafanaBtn">
            <i class="fas fa-chart-line"></i>
            Grafana
          </button>
          <button class="control-btn" id="jsonBtn">
            <i class="fas fa-code"></i>
            JSON
          </button>
          <button class="control-btn" id="fullscreenBtn">
            <i class="fas fa-expand"></i>
            Vollbild
          </button>
        </div>
              </div>
        
        <!-- Fullscreen Content with Scrollbar -->
        <div class="object-details-content">
        
        <!-- Temperatur-Analyse Container -->
        <div class="temp-analysis-container" id="tempAnalysisContainer">
          <div class="temp-analysis-header">
            <h4 class="temp-analysis-title">
              <i class="fas fa-thermometer-half"></i>
              Temperatur-Analyse
            </h4>
            <button class="temp-analysis-close" id="tempAnalysisClose">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="temp-analysis-content" id="tempAnalysisContent">
            <!-- Temperatur-Analyse Inhalt wird hier eingefügt -->
          </div>
        </div>
        
        <div class="no-selection-state" id="noSelectionState">
          <i class="fas fa-cube"></i>
          <h4>Kein Objekt ausgewählt</h4>
          <p>Wählen Sie ein Objekt aus der Anlagen-Übersicht aus, um Details anzuzeigen.</p>
        </div>
        
        <div class="object-details-grid" id="objectDetailsGrid" style="display: none;">
          <div class="detail-section">
            <h4>Grunddaten</h4>
            <div class="detail-item">
              <label>Objekt-ID:</label>
              <span id="objectId">-</span>
            </div>
            <div class="detail-item">
              <label>Name:</label>
              <span id="objectName">-</span>
            </div>
            <div class="detail-item">
              <label>Gruppe:</label>
              <span id="objectGroup">-</span>
            </div>
            <div class="detail-item">
              <label>Standort:</label>
              <span id="objectLocation">-</span>
            </div>
            <div class="detail-item">
              <label>Anlagentyp:</label>
              <span id="objectType">-</span>
            </div>
            <div class="detail-item">
              <label>Status:</label>
              <span id="objectStatus">-</span>
            </div>
            <div class="detail-item">
              <label>Letzte Meldung:</label>
              <span id="objectLastMessage">-</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4>Temperaturdaten</h4>
            <div class="detail-item">
              <label>Vorlauftemperatur:</label>
              <span id="tempVorlauf" style="color: #059669; font-weight: 600;">-</span>
            </div>
            <div class="detail-item">
              <label>Rücklauftemperatur:</label>
              <span id="tempRuecklauf" style="color: #0891b2; font-weight: 600;">-</span>
            </div>
            <div class="detail-item">
              <label>Temperaturdifferenz:</label>
              <span id="tempDifferenz" style="color: #7c3aed; font-weight: 600;">-</span>
            </div>
            <div class="detail-item">
              <label>Außentemperatur:</label>
              <span id="tempAussen">-</span>
            </div>
            <div class="detail-item">
              <label>Solltemperatur VL:</label>
              <span id="tempSoll">-</span>
            </div>
            <div class="detail-item">
              <label>Regelabweichung:</label>
              <span id="tempAbweichung">-</span>
            </div>
            <div class="detail-item">
              <label>Trend (24h):</label>
              <span id="tempTrend">-</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4>Betriebsdaten</h4>
            <div class="detail-item">
              <label>Betriebsstunden:</label>
              <span id="betriebsstunden">-</span>
            </div>
            <div class="detail-item">
              <label>Brennerstarts heute:</label>
              <span id="brennerstarts">-</span>
            </div>
            <div class="detail-item">
              <label>Laufzeit heute:</label>
              <span id="laufzeit">-</span>
            </div>
            <div class="detail-item">
              <label>Energieverbrauch (24h):</label>
              <span id="energieverbrauch">-</span>
            </div>
            <div class="detail-item">
              <label>Pumpenleistung:</label>
              <span id="pumpenleistung">-</span>
            </div>
            <div class="detail-item">
              <label>Letzte Wartung:</label>
              <span id="letzteWartung">-</span>
            </div>
            <div class="detail-item">
              <label>Nächste Wartung:</label>
              <span id="naechsteWartung">-</span>
            </div>
            <div class="detail-item">
              <label>Störmeldungen:</label>
              <span id="stoermeldungen">-</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4>Grafana Dashboard</h4>
            <div id="grafanaContent" style="background: #f3f4f6; text-align: center; color: #6b7280;">
              <i class="fas fa-chart-line" style="font-size: 32px; margin-bottom: 12px; color: #3b82f6;"></i>
              <p style="margin: 0; font-weight: 600;">Grafana Dashboard</p>
              <p style="margin: 8px 0 0 0; font-size: 12px;">
                Hier würden die spezifischen Diagramme angezeigt werden
              </p>
            </div>
          </div>
          
          <div class="detail-section">
            <h4>JSON Daten</h4>
            <div id="jsonContent" style="background: #1f2937; color: #e5e7eb; padding: 16px; border-radius: 6px; font-family: monospace; font-size: 12px;">
              <pre id="jsonData">{
  "message": "Wählen Sie ein Objekt aus"
}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Panel Toggle (Left Panel)
    const leftPanelElement = document.getElementById('leftPanel');
    const panelToggleBtn = document.getElementById('panelToggleBtn');
    const panelToggleIcon = panelToggleBtn.querySelector('i');
    const panelToggleTooltip = panelToggleBtn.querySelector('.panel-toggle-tooltip');
    const panelCollapsedIcon = document.getElementById('panelCollapsedIcon');
    
    panelToggleBtn.addEventListener('click', function() {
      leftPanelElement.classList.toggle('collapsed');
      
      if (leftPanelElement.classList.contains('collapsed')) {
        panelToggleIcon.className = 'fas fa-chevron-right';
        panelToggleTooltip.textContent = 'Panel öffnen';
      } else {
        panelToggleIcon.className = 'fas fa-chevron-left';
        panelToggleTooltip.textContent = 'Panel schließen';
      }
    });
    
    // Click on collapsed icon to expand and show overview
    panelCollapsedIcon.addEventListener('click', function() {
      // Expand the panel
      leftPanelElement.classList.remove('collapsed');
      panelToggleIcon.className = 'fas fa-chevron-left';
      panelToggleTooltip.textContent = 'Panel schließen';
      
      // Show the overview/object list
      const noSelectionState = document.getElementById('noSelectionState');
      const objectDetailsGrid = document.getElementById('objectDetailsGrid');
      const tempContainer = document.getElementById('tempAnalysisContainer');
      
      // Hide object details and show overview
      if (noSelectionState) noSelectionState.style.display = 'block';
      if (objectDetailsGrid) objectDetailsGrid.style.display = 'none';
      if (tempContainer) tempContainer.classList.remove('active');
      
      // Reset control buttons
      document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
      
      // Reset toggle button
      const toggleBtn = document.getElementById('toggleAllBtn');
      if (toggleBtn) toggleBtn.classList.remove('active');
      
      // Expand the first category section (Kritische Anlagen) to show object list
      const firstCategorySection = document.querySelector('.category-section');
      if (firstCategorySection) {
        // Close all sections first
        const allSections = document.querySelectorAll('.category-section');
        allSections.forEach(section => {
          section.classList.remove('expanded');
          section.classList.add('collapsed');
          const chevron = section.querySelector('.expand-btn i');
          if (chevron) {
            chevron.style.transform = 'rotate(0deg)';
          }
        });
        
        // Expand the first section (Kritische Anlagen)
        firstCategorySection.classList.remove('collapsed');
        firstCategorySection.classList.add('expanded');
        const firstChevron = firstCategorySection.querySelector('.expand-btn i');
        if (firstChevron) {
          firstChevron.style.transform = 'rotate(90deg)';
        }
        
        console.log('✅ Erste Kategorie (Kritische Anlagen) aufgeklappt');
      }
      
      console.log('✅ Sidebar geöffnet - Übersicht/Objekt-Liste angezeigt');
    });
    
    // Category Section Toggle (Accordion behavior)
    const categoryHeaders = document.querySelectorAll('.category-header');
    categoryHeaders.forEach(header => {
      header.addEventListener('click', function() {
        const section = this.parentElement;
        const chevron = this.querySelector('.expand-btn i');
        
        // Close all other sections first
        const allSections = document.querySelectorAll('.category-section');
        allSections.forEach(otherSection => {
          if (otherSection !== section) {
            otherSection.classList.remove('expanded');
            otherSection.classList.add('collapsed');
            const otherChevron = otherSection.querySelector('.expand-btn i');
            if (otherChevron) {
              otherChevron.style.transform = 'rotate(0deg)';
            }
          }
        });
        
        // Toggle current section
        section.classList.toggle('expanded');
        section.classList.toggle('collapsed');
        
        if (section.classList.contains('expanded')) {
          chevron.style.transform = 'rotate(90deg)';
        } else {
          chevron.style.transform = 'rotate(0deg)';
        }
      });
    });
    
    // Toggle All Categories
    const toggleAllBtn = document.getElementById('toggleAllBtn');
    let allExpanded = false;
    
    toggleAllBtn.addEventListener('click', function() {
      // Toggle temperature analysis display
      toggleTemperatureAnalysis();
    });
    
    // Close button for temperature analysis
    const tempAnalysisClose = document.getElementById('tempAnalysisClose');
    if (tempAnalysisClose) {
      tempAnalysisClose.addEventListener('click', function() {
        const toggleBtn = document.getElementById('toggleAllBtn');
        const tempContainer = document.getElementById('tempAnalysisContainer');
        const noSelectionState = document.getElementById('noSelectionState');
        const objectDetailsGrid = document.getElementById('objectDetailsGrid');
        
        tempContainer.classList.remove('active');
        toggleBtn.classList.remove('active');
        if (noSelectionState) noSelectionState.style.display = 'block';
        if (objectDetailsGrid) objectDetailsGrid.style.display = 'none';
      });
    }
    
    // Object Selection from Tables
    const objectRows = document.querySelectorAll('.object-row');
    const objectLinks = document.querySelectorAll('.object-link');
    const actionBtns = document.querySelectorAll('.action-btn');
    
    // Add click handlers to object rows
    objectRows.forEach(row => {
      row.addEventListener('click', function() {
        // Remove selection from all rows
        objectRows.forEach(r => r.classList.remove('selected'));
        
        // Add selection to clicked row
        this.classList.add('selected');
        
        // Load object details
        const objectName = this.getAttribute('data-object');
        loadObjectDetails(objectName);
      });
    });
    
    // Add click handlers to object links
    objectLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const row = this.closest('.object-row');
        if (row) {
          row.click();
        }
      });
    });
    
    // Add click handlers to action buttons
    actionBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const row = this.closest('.object-row');
        if (row) {
          row.click();
        }
      });
    });
    
    // Control Buttons
    const grafanaBtn = document.getElementById('grafanaBtn');
    const jsonBtn = document.getElementById('jsonBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const objectDetailsGrid = document.getElementById('objectDetailsGrid');
    
    grafanaBtn.addEventListener('click', function() {
      // Reset all modes
      objectDetailsGrid.classList.remove('grafana-mode', 'json-mode');
      document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
      
      // Activate Grafana mode
      objectDetailsGrid.classList.add('grafana-mode');
      this.classList.add('active');
      
      // Load Grafana for current object - get the most recent object ID
      const currentObjectId = document.getElementById('objectId').textContent;
      const objectTitle = document.getElementById('objectDetailsTitle');
      
      // Use the current object ID from the objectId element (this should be the real numeric ID)
      let objectId = currentObjectId;
      
      // If we have a valid numeric object ID, use it directly
      if (objectId && objectId !== '-' && !isNaN(objectId)) {
        // This is the real object ID from the database
        console.log('🎯 Using numeric object ID from element:', objectId);
      } else {
        // Fallback: try to extract from title if numeric ID is not available
        if (objectTitle && objectTitle.textContent) {
          const titleText = objectTitle.textContent;
          // Extract object ID from title (e.g., "HK-001 Hauptgebäude - Details" -> "HK-001")
          const match = titleText.match(/([A-Z]{2}-\d+)/);
          if (match && match[1]) {
            objectId = match[1];
            console.log('🎯 Using extracted object ID from title:', objectId);
          }
        }
      }
      
      if (objectId && objectId !== '-') {
        console.log('🎯 Loading Grafana for current object ID:', objectId);
        loadGrafanaForObject(objectId);
      } else {
        console.warn('⚠️ No valid object ID found for Grafana');
      }
      
      console.log('Grafana mode activated for object:', objectId);
    });
    
    // Load Grafana for specific object
    function loadGrafanaForObject(objectId) {
      const grafanaContent = document.getElementById('grafanaContent');
      if (grafanaContent) {
        // Show loading state
        grafanaContent.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; color: #6b7280;">
            <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px; color: #3b82f6;"></i>
            <p style="margin: 0; font-weight: 600;">Lade Grafana Dashboard...</p>
            <p style="margin: 8px 0 0 0; font-size: 12px;">Objekt ID: ${objectId}</p>
          </div>
        `;
        
        // Create iframe with grafana-tabs-id.html
        setTimeout(() => {
          grafanaContent.innerHTML = `
            <div style="position: relative; width: 100%; height: 600px;">
              <iframe 
                id="grafanaIframe"
                src="/grafana-tabs-id.html?id=${objectId}&typ=waechter" 
                style="width: 100%; height: 100%; border: none; border-radius: 8px;"
                title="Grafana Dashboard für Objekt ${objectId}"
              ></iframe>
            </div>
          `;
        }, 500);
      }
    }
    

    
    jsonBtn.addEventListener('click', function() {
      // Reset all modes
      objectDetailsGrid.classList.remove('grafana-mode', 'json-mode');
      document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
      
      // Activate JSON mode
      objectDetailsGrid.classList.add('json-mode');
      this.classList.add('active');
      
      console.log('JSON mode activated');
    });
    
    fullscreenBtn.addEventListener('click', function() {
      // Reset all modes (original behavior)
      objectDetailsGrid.classList.remove('grafana-mode', 'json-mode');
      document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
      
      console.log('Fullscreen mode activated');
    });
    
    // Load object details
    function loadObjectDetails(objectName) {
      const objectTitle = document.getElementById('objectDetailsTitle');
      const objectSubtitle = document.getElementById('objectDetailsSubtitle');
      const noSelectionState = document.getElementById('noSelectionState');
      
      if (objectTitle) {
        objectTitle.innerHTML = `<i class="fas fa-cube"></i> ${objectName} - Details`;
      }
      
      if (objectSubtitle) {
        const gruppe = getGruppeFromObjectName(objectName);
        objectSubtitle.textContent = `${objectName} (${gruppe}) • Online seit 2 Tagen`;
      }
      
      // Ensure the left panel is expanded when an object is selected
      const leftPanelElement = document.getElementById('leftPanel');
      if (leftPanelElement && leftPanelElement.classList.contains('collapsed')) {
        leftPanelElement.classList.remove('collapsed');
        const panelToggleIcon = document.querySelector('#panelToggleBtn i');
        if (panelToggleIcon) {
          panelToggleIcon.className = 'fas fa-chevron-left';
        }
        const panelToggleTooltip = document.querySelector('.panel-toggle-tooltip');
        if (panelToggleTooltip) {
          panelToggleTooltip.textContent = 'Panel schließen';
        }
      }
      
      // Hide no selection state and show details
      noSelectionState.style.display = 'none';
      objectDetailsGrid.style.display = 'grid';
      
      // Update detail sections with new object data
      updateDetailSections(objectName);
      
      console.log('✅ Objekt-Details geladen und Panel geöffnet:', objectName);
    }
    
    // Get gruppe from object name
    function getGruppeFromObjectName(objectName) {
      if (objectName.includes('HK-')) return 'Heimkehr';
      if (objectName.includes('ST-')) return 'Strawa';
      if (objectName.includes('CS-')) return 'Cursor';
      return 'Unbekannt';
    }
    
    // Update detail sections
    function updateDetailSections(objectName) {
      const mockData = generateMockDataForObject(objectName);
      
      // Update Grunddaten
      document.getElementById('objectId').textContent = mockData.objectId;
      document.getElementById('objectName').textContent = mockData.name;
      document.getElementById('objectGroup').textContent = mockData.gruppe;
      document.getElementById('objectLocation').textContent = mockData.location;
      document.getElementById('objectType').textContent = mockData.type;
      document.getElementById('objectStatus').innerHTML = `<span class="status-indicator status-${mockData.status}"><i class="fas fa-circle"></i> ${mockData.status}</span>`;
      document.getElementById('objectLastMessage').textContent = 'vor 2 Minuten';
      
      // Update Temperaturdaten
      document.getElementById('tempVorlauf').textContent = mockData.temperature.vorlauf.current + '°C';
      document.getElementById('tempRuecklauf').textContent = mockData.temperature.ruecklauf.current + '°C';
      document.getElementById('tempDifferenz').textContent = mockData.temperature.ruecklauf.differential + '°C';
      document.getElementById('tempAussen').textContent = mockData.temperature.outside + '°C';
      document.getElementById('tempSoll').textContent = mockData.temperature.vorlauf.target + '°C';
      document.getElementById('tempAbweichung').textContent = (mockData.temperature.vorlauf.deviation > 0 ? '+' : '') + mockData.temperature.vorlauf.deviation + '°C';
      document.getElementById('tempTrend').textContent = (mockData.temperature.vorlauf.trend24h > 0 ? '↗ +' : '↘ ') + mockData.temperature.vorlauf.trend24h + '°C';
      
      // Update Betriebsdaten
      document.getElementById('betriebsstunden').textContent = mockData.operation.totalHours.toLocaleString() + ' h';
      document.getElementById('brennerstarts').textContent = mockData.operation.burnerStarts + ' Starts';
      document.getElementById('laufzeit').textContent = mockData.operation.runtimeToday;
      document.getElementById('energieverbrauch').textContent = mockData.operation.energyConsumption24h.toLocaleString() + ' kWh';
      document.getElementById('pumpenleistung').textContent = mockData.operation.pumpPower + '%';
      document.getElementById('letzteWartung').textContent = mockData.maintenance.last;
      document.getElementById('naechsteWartung').textContent = mockData.maintenance.next + ' (in ' + mockData.maintenance.daysUntilNext + ' Tagen)';
      document.getElementById('stoermeldungen').textContent = mockData.maintenance.activeFaults === 0 ? 'Keine aktiven Störungen' : mockData.maintenance.activeFaults + ' aktive Störungen';
      
      // Update Grafana Content - check if Grafana mode is active
      const objectDetailsGrid = document.getElementById('objectDetailsGrid');
      if (objectDetailsGrid && objectDetailsGrid.classList.contains('grafana-mode')) {
        // If Grafana mode is active, load the iframe
        const objectId = mockData.objectId;
        if (objectId) {
          loadGrafanaForObject(objectId);
        }
      } else {
        // Show default Grafana content
        document.getElementById('grafanaContent').innerHTML = `
          <i class="fas fa-chart-line" style="font-size: 32px; margin-bottom: 12px; color: #3b82f6;"></i>
          <p style="margin: 0; font-weight: 600;">Grafana Dashboard - ${objectName}</p>
          <p style="margin: 8px 0 0 0; font-size: 12px;">
            Hier würden die spezifischen Diagramme für ${objectName} angezeigt werden
          </p>
        `;
      }
      
      // Update JSON Data
      document.getElementById('jsonData').textContent = JSON.stringify(mockData, null, 2);
      
      console.log('✅ Details für', objectName, 'geladen');
    }
    
    // Generate mock data for different objects
    function generateMockDataForObject(objectName) {
      const gruppe = getGruppeFromObjectName(objectName);
      const objectId = objectName.split(' ')[0];
      
      // Generate status based on object type and random factors
      const status = objectName.includes('Lagerhalle') ? 'offline' : 
                    objectName.includes('Überhitzung') || objectName.includes('Wartung') ? 'warning' : 
                    'online';
      
      return {
        objectId: objectId,
        name: objectName,
        gruppe: gruppe,
        location: getLocationFromObject(objectName),
        type: getTypeFromObject(objectName),
        status: status,
        connection: {
          quality: Math.round((Math.random() * 10 + 90) * 10) / 10,
          lastSeen: new Date().toISOString(),
          interval: 30
        },
        temperature: {
          vorlauf: {
            current: Math.round((Math.random() * 25 + 50) * 10) / 10,
            target: Math.round((Math.random() * 20 + 55) * 10) / 10,
            deviation: Math.round((Math.random() * 4 - 2) * 10) / 10,
            trend24h: Math.round((Math.random() * 6 - 3) * 10) / 10,
            alarm: {
              warning: 75.0,
              critical: 85.0
            }
          },
          ruecklauf: {
            current: Math.round((Math.random() * 15 + 35) * 10) / 10,
            differential: Math.round((Math.random() * 10 + 15) * 10) / 10
          },
          outside: Math.round((Math.random() * 20 + 5) * 10) / 10
        },
        operation: {
          totalHours: Math.floor(Math.random() * 5000 + 2000),
          runtimeToday: `${Math.floor(Math.random() * 12)}h ${Math.floor(Math.random() * 60)}min`,
          burnerStarts: Math.floor(Math.random() * 20 + 5),
          pumpPower: Math.floor(Math.random() * 40 + 60),
          energyConsumption24h: Math.floor(Math.random() * 800 + 400)
        },
        maintenance: {
          last: "2025-06-15",
          next: "2025-12-15",
          daysUntilNext: Math.floor(Math.random() * 60 + 10),
          activeFaults: status === 'offline' ? Math.floor(Math.random() * 3 + 1) : 0
        },
        monitoring: {
          dataPoints24h: 2880,
          alarmThresholds: {
            differentialCritical: 25
          }
        },
        metadata: {
          firmware: `v2.${Math.floor(Math.random() * 3 + 1)}.${Math.floor(Math.random() * 10)}`,
          hardware: getHardwareFromObject(objectName),
          lastUpdate: new Date().toISOString(),
          timezone: "Europe/Berlin"
        },
        timestamp: new Date().toISOString()
      };
    }
    
    // Helper functions for mock data generation
    function getLocationFromObject(objectName) {
      if (objectName.includes('Hauptgebäude')) return 'Gebäude A, EG-UG';
      if (objectName.includes('Sporthalle')) return 'Sporthalle, Nebengebäude';
      if (objectName.includes('Schwimmbad')) return 'Schwimmhalle, UG';
      if (objectName.includes('Bürokomplex')) return 'Bürokomplex A, 1.-3. OG';
      if (objectName.includes('Lagerhalle')) return 'Lagerhalle B, EG';
      if (objectName.includes('Serverraum')) return 'IT-Zentrum, 2. OG';
      if (objectName.includes('Bürotrakt')) return 'Bürotrakt C, 1.-2. OG';
      if (objectName.includes('Kantine')) return 'Kantine, EG';
      if (objectName.includes('Wohnheim')) return 'Wohnheim, 1.-4. OG';
      if (objectName.includes('Produktionshalle')) return 'Produktionshalle A, EG';
      if (objectName.includes('Werkstatt')) return 'Werkstatt, EG';
      if (objectName.includes('Maschinenhalle')) return 'Maschinenhalle B, EG';
      if (objectName.includes('Rechenzentrum')) return 'Rechenzentrum, 3. OG';
      if (objectName.includes('Neubau')) return 'Neubau Ost, 1.-2. OG';
      return 'Gebäude unbekannt';
    }
    
    function getTypeFromObject(objectName) {
      if (objectName.includes('Heizkreis') || objectName.includes('Hauptgebäude')) return 'Zentralheizung';
      if (objectName.includes('Fußbodenheizung')) return 'Fußbodenheizung';
      if (objectName.includes('Poolheizung')) return 'Schwimmbadheizung';
      if (objectName.includes('Zentralheizung')) return 'Zentralheizung';
      if (objectName.includes('Hallenheizung')) return 'Hallenheizung';
      if (objectName.includes('Klimaanlage')) return 'Klimaanlage';
      if (objectName.includes('Lüftungsanlage')) return 'Lüftungsanlage';
      if (objectName.includes('Warmwasserbereitung')) return 'Warmwasserbereitung';
      if (objectName.includes('Prozesswärme')) return 'Prozesswärme';
      if (objectName.includes('Sporthalle')) return 'Fußbodenheizung';
      if (objectName.includes('Schwimmbad')) return 'Poolheizung';
      if (objectName.includes('Serverraum')) return 'Klimaanlage';
      if (objectName.includes('Bürotrakt')) return 'Lüftungsanlage';
      if (objectName.includes('Kantine')) return 'Warmwasserbereitung';
      if (objectName.includes('Produktionshalle')) return 'Prozesswärme';
      return 'Standard-Heizung';
    }
    
    function getHardwareFromObject(objectName) {
      if (objectName.includes('HK-')) return 'HK-Monitor-Pro';
      if (objectName.includes('ST-')) return 'ST-Controller-Plus';
      if (objectName.includes('CS-')) return 'CS-SmartSensor';
      return 'Universal-Monitor';
    }
    
    // Split-Resizer
    const splitResizer = document.getElementById('splitResizer');
    let isResizing = false;
    
    splitResizer.addEventListener('mousedown', function(e) {
      isResizing = true;
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isResizing) return;
      
      const container = document.querySelector('.split-view-container');
      const left = document.getElementById('leftPanel');
      let newWidth = e.clientX - container.getBoundingClientRect().left;
      
      if (newWidth < 300) newWidth = 300;
      if (newWidth > window.innerWidth * 0.7) newWidth = window.innerWidth * 0.7;
      
      left.style.flex = '0 0 ' + newWidth + 'px';
      left.style.minWidth = newWidth + 'px';
      left.style.maxWidth = newWidth + 'px';
    });
    
    document.addEventListener('mouseup', function(e) {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
      }
    });
    
    // Netzwächter Info Button
    const netzwaechterInfoBtn = document.getElementById('netzwaechterInfoBtn');
    netzwaechterInfoBtn.addEventListener('click', function() {
      this.classList.toggle('active');
      
      if (this.classList.contains('active')) {
        console.log('Netzwächter Info aktiviert');
        showNetzwaechterInfo();
      } else {
        console.log('Netzwächter Info deaktiviert');
        hideNetzwaechterInfo();
      }
    });
    
    // Show Netzwächter Info
    function showNetzwaechterInfo() {
      const objectDetailsContent = document.querySelector('.object-details-content');
      const objectDetailsGrid = document.getElementById('objectDetailsGrid');
      const noSelectionState = document.getElementById('noSelectionState');
      
      // Hide existing content
      if (objectDetailsGrid) objectDetailsGrid.style.display = 'none';
      if (noSelectionState) noSelectionState.style.display = 'none';
      
      // Create or show iframe for netzwaechter-info.html
      let infoIframe = document.getElementById('netzwaechterInfoIframe');
      if (!infoIframe) {
        infoIframe = document.createElement('iframe');
        infoIframe.id = 'netzwaechterInfoIframe';
        infoIframe.src = 'netzwaechter-info.html';
        infoIframe.style.cssText = `
          width: 100%;
          height: 100%;
          border: none;
          background: white;
        `;
        objectDetailsContent.appendChild(infoIframe);
      } else {
        infoIframe.style.display = 'block';
      }
      
      // Update header
      const objectTitle = document.getElementById('objectDetailsTitle');
      if (objectTitle) {
        objectTitle.innerHTML = `<i class="fas fa-info-circle"></i> Netzwächter Informationen`;
      }
      
      const objectSubtitle = document.getElementById('objectDetailsSubtitle');
      if (objectSubtitle) {
        objectSubtitle.textContent = 'Detaillierte Informationen über das Netzwächter-System';
      }
    }
    
    // Hide Netzwächter Info
    function hideNetzwaechterInfo() {
      const infoIframe = document.getElementById('netzwaechterInfoIframe');
      if (infoIframe) {
        infoIframe.style.display = 'none';
      }
      
      // Show previous content
      const objectDetailsGrid = document.getElementById('objectDetailsGrid');
      const noSelectionState = document.getElementById('noSelectionState');
      
      // Check if we have a selected object
      const selectedRow = document.querySelector('.object-row.selected');
      if (selectedRow) {
        // Show object details
        if (objectDetailsGrid) objectDetailsGrid.style.display = 'grid';
        if (noSelectionState) noSelectionState.style.display = 'none';
        
        // Restore object details header
        const objectName = selectedRow.getAttribute('data-object');
        const objectId = selectedRow.getAttribute('data-object-id');
        
        const objectTitle = document.getElementById('objectDetailsTitle');
        if (objectTitle) {
          objectTitle.innerHTML = `<i class="fas fa-cube"></i> ${objectName} - Details`;
        }
        
        const objectData = objectsData.find(obj => 
          obj.id === objectId || 
          obj.objectId === objectId || 
          obj.name === objectName
        );
        
        if (objectData) {
          const gruppe = getMandantName(objectData.mandantId || objectData.mandant_id);
          const status = objectData.online ? 'Online' : 'Offline';
          const statusSince = objectData.online ? 'seit 2 Tagen' : 'seit ' + (Math.floor(Math.random() * 8 + 1)) + 'h';
          
          const objectSubtitle = document.getElementById('objectDetailsSubtitle');
          if (objectSubtitle) {
            objectSubtitle.textContent = `${objectName} (${gruppe}) • ${status} ${statusSince}`;
          }
        }
      } else {
        // Show no selection state
        if (objectDetailsGrid) objectDetailsGrid.style.display = 'none';
        if (noSelectionState) noSelectionState.style.display = 'flex';
        
        const objectTitle = document.getElementById('objectDetailsTitle');
        if (objectTitle) {
          objectTitle.innerHTML = `<i class="fas fa-cube"></i> Objekt auswählen`;
        }
        
        const objectSubtitle = document.getElementById('objectDetailsSubtitle');
        if (objectSubtitle) {
          objectSubtitle.textContent = 'Wählen Sie ein Objekt aus der Übersicht aus';
        }
      }
    }
    
    // API Data Loading
    let mandantsData = [];
    let objectsData = [];
    let tempAnalysisData = [];
    
    // Load data from APIs
    async function loadAPIData() {
      try {
        console.log('🔄 Lade API-Daten...');
        
        // Get token from localStorage
        let token = localStorage.getItem('token');
        
        // Auto-login if no token available
        if (!token) {
          console.log('🔐 Kein Token gefunden, versuche Auto-Login...');
          try {
            const loginResponse = await fetch('/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: 'admin',
                password: 'admin123'
              })
            });
            
            const loginData = await loginResponse.json();
            if (loginData.success) {
              token = loginData.data.accessToken || loginData.data.token;
              localStorage.setItem('token', token);
              localStorage.setItem('user', JSON.stringify(loginData.data.user));
              console.log('✅ Auto-Login erfolgreich');
            } else {
              throw new Error('Auto-Login fehlgeschlagen: ' + loginData.error);
            }
          } catch (loginError) {
            console.warn('⚠️ Auto-Login fehlgeschlagen:', loginError.message);
            throw new Error('Kein Authentifizierungs-Token verfügbar und Auto-Login fehlgeschlagen');
          }
        }
        
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        // Load mandants with objects
        const mandantsResponse = await fetch('/api/mandants?filter=withObjects', {
          headers: headers
        });
        if (mandantsResponse.ok) {
          const mandantsResult = await mandantsResponse.json();
          mandantsData = mandantsResult.success && mandantsResult.data ? mandantsResult.data : mandantsResult;
          console.log('✅ Mandants geladen:', mandantsData.length);
        } else {
          console.error('❌ Fehler beim Laden der Mandants:', mandantsResponse.status);
        }
        
        // Load all objects optimized
        const objectsResponse = await fetch('/api/objects/list?includeAll=true', {
          headers: headers
        });
        if (objectsResponse.ok) {
          const objectsResult = await objectsResponse.json();
          objectsData = objectsResult.success && objectsResult.data ? objectsResult.data.objects : objectsResult;
          console.log('✅ Objekte geladen:', objectsData.length);
          console.log('🔍 Erste 3 Objekte:', objectsData.slice(0, 3));
        } else {
          console.error('❌ Fehler beim Laden der Objekte:', objectsResponse.status);
        }
        
        // Load temperature analysis data
        const tempResponse = await fetch('/api/objects?tempAnalysisMandantId=1', {
          headers: headers
        });
        if (tempResponse.ok) {
          const tempResult = await tempResponse.json();
          tempAnalysisData = tempResult.success ? tempResult.data : tempResult;
          console.log('✅ Temperatur-Analyse geladen:', tempAnalysisData.length);
          console.log('🔍 Erste 3 Temperatur-Objekte:', tempAnalysisData.slice(0, 3));
          
          // Debug: Prüfe tempGrenzwert Struktur
          tempAnalysisData.forEach((obj, index) => {
            if (index < 5 && obj.tempGrenzwert) {
              console.log(`🌡️ Debug Objekt ${index}:`, {
                name: obj.name || obj.objectName,
                tempGrenzwert: obj.tempGrenzwert
              });
            }
          });
        } else {
          console.error('❌ Fehler beim Laden der Temperatur-Analyse:', tempResponse.status);
        }
        
        // Process and categorize data
        processObjectData();
        
      } catch (error) {
        console.error('❌ Fehler beim Laden der API-Daten:', error);
        // Fallback to mock data if API fails
        console.log('⚠️ Verwende Mock-Daten als Fallback');
      }
    }
    
    // Hilfsfunktion: Prüft ob ein Datum heute ist
    function isUpdatedToday(updateTime) {
      if (!updateTime) {
        console.log('🔍 Kein updateTime vorhanden');
        return false;
      }
      
      try {
        const updateDate = new Date(updateTime);
        const today = new Date();
        
        // Vergleiche nur Jahr, Monat und Tag (ignoriere Uhrzeit)
        const isSameDay = updateDate.getFullYear() === today.getFullYear() &&
                         updateDate.getMonth() === today.getMonth() &&
                         updateDate.getDate() === today.getDate();
        
        console.log('📅 Datum-Vergleich:', {
          updateTime: updateTime,
          updateDate: updateDate.toLocaleString('de-DE'),
          today: today.toLocaleString('de-DE'),
          isSameDay: isSameDay
        });
        
        return isSameDay;
      } catch (error) {
        console.error('❌ Fehler beim Parsen des Update-Datums:', updateTime, error);
        return false;
      }
    }

    // Process and categorize object data
    function processObjectData() {
      const categorizedData = {
        critical: [],
        warnings: [],
        offline: [],
        highConsumption: [],
        optimized: []
      };
      
      // Process objects for categorization
      objectsData.forEach(obj => {
        // Check if object is offline (not online)
        if (!obj.online || obj.online === false) {
          categorizedData.offline.push(obj);
          return;
        }
        
        // Find temperature analysis data for this object
        const tempData = tempAnalysisData.find(temp => 
          temp.objectId === obj.id || 
          temp.objectName === obj.name ||
          temp.objectId === obj.objectId
        );
        
        if (tempData && tempData.tempGrenzwert) {
          // Parse tempGrenzwert JSON structure for critical analysis
          const tempGrenzwert = tempData.tempGrenzwert;
          let isCritical = false;
          let hasWarnings = false;
          
          console.log('🌡️ Analyzing tempGrenzwert for', obj.name || obj.objectName, tempGrenzwert);
          
          // Check each temperature measurement in tempGrenzwert
          Object.keys(tempGrenzwert).forEach(key => {
            const grenzwertText = tempGrenzwert[key];
            
            // Parse the grenzwert text patterns from server logs:
            // Critical: "26°C ≤ kritisch (30°C)" - temperature is at or below critical threshold
            // Warning: "48°C > warnung (45°C)" - temperature is above warning threshold  
            // Normal: "58°C > normal (50°C)" - temperature is above normal threshold
            
            if (grenzwertText.includes('≤ kritisch') || grenzwertText.includes('≤ critical')) {
              isCritical = true;
              console.log('🔴 Critical temperature detected:', key, grenzwertText);
            } else if (grenzwertText.includes('> warnung') || grenzwertText.includes('> warning') ||
                       grenzwertText.includes('≥ warnung') || grenzwertText.includes('≥ warning')) {
              hasWarnings = true;
              console.log('🟡 Warning temperature detected:', key, grenzwertText);
            }
            // Normal case: "58°C > normal (50°C)" - do nothing, these are not critical or warnings
          });
          
          // Categorize based on tempGrenzwert analysis
          if (isCritical) {
            // Filtere kritische Anlagen nur mit heutigem Update-Datum
            if (isUpdatedToday(tempData.updateTime)) {
              categorizedData.critical.push({...obj, tempData, tempGrenzwert});
              console.log('✅ Kritische Anlage mit heutigem Update hinzugefügt:', obj.name || obj.objectName, tempData.updateTime);
            } else {
              console.log('⏭️ Kritische Anlage übersprungen (nicht heute aktualisiert):', obj.name || obj.objectName, tempData.updateTime);
            }
          } else if (hasWarnings) {
            categorizedData.warnings.push({...obj, tempData, tempGrenzwert});
          } else {
            categorizedData.optimized.push({...obj, tempData, tempGrenzwert});
          }
        } else if (tempData) {
          // Fallback: Parse temperature values and limits if no tempGrenzwert
          const vlTemp = parseFloat(tempData.vlTemperature || tempData.vorlaufTemperatur || 0);
          const rlTemp = parseFloat(tempData.rlTemperature || tempData.ruecklaufTemperatur || 0);
          const vlLimit = parseFloat(tempData.vlLimit || tempData.vlGrenzwert || 85);
          const rlLimit = parseFloat(tempData.rlLimit || tempData.rlGrenzwert || 75);
          
          if (vlTemp > vlLimit || rlTemp > rlLimit) {
            // Filtere kritische Anlagen nur mit heutigem Update-Datum
            if (isUpdatedToday(tempData.updateTime)) {
              categorizedData.critical.push({...obj, tempData});
              console.log('✅ Kritische Anlage (Fallback) mit heutigem Update hinzugefügt:', obj.name || obj.objectName, tempData.updateTime);
            } else {
              console.log('⏭️ Kritische Anlage (Fallback) übersprungen (nicht heute aktualisiert):', obj.name || obj.objectName, tempData.updateTime);
            }
          } else if (obj.hasWarnings || obj.warningCount > 0 || tempData.hasWarnings) {
            categorizedData.warnings.push({...obj, tempData});
          } else {
            categorizedData.optimized.push({...obj, tempData});
          }
        } else {
          // Objects without temperature data
          if (obj.hasWarnings || obj.warningCount > 0) {
            categorizedData.warnings.push(obj);
          } else {
            categorizedData.optimized.push(obj);
          }
        }
      });
      
      console.log('📊 Kategorisierte Objekte:', {
        critical: categorizedData.critical.length,
        warnings: categorizedData.warnings.length,
        offline: categorizedData.offline.length,
        highConsumption: categorizedData.highConsumption.length,
        optimized: categorizedData.optimized.length
      });
      
      // Update tables with real data
      updateCategoryTables(categorizedData);
    }
    
    // Update category tables with real data
    function updateCategoryTables(data) {
      // Update Critical Systems Table
      if (data.critical.length > 0) {
        updateCriticalTable(data.critical);
      }
      
      // Update Warnings Table
      if (data.warnings.length > 0) {
        updateWarningsTable(data.warnings);
      }
      
      // Update Offline Table
      if (data.offline.length > 0) {
        updateOfflineTable(data.offline);
      }
      
      // Update count badges
      updateCountBadges(data);
      
      // Select first available object
      selectFirstAvailableObject(data);
    }
    
    // Update Critical Systems Table with detailed tempGrenzwert analysis
    function updateCriticalTable(criticalObjects) {
      const tableBody = document.querySelector('.category-section[data-category="critical"] tbody');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      criticalObjects.forEach(obj => {
        const tempData = obj.tempData || {};
        const tempGrenzwert = obj.tempGrenzwert || tempData.tempGrenzwert || {};
        const gruppe = getMandantName(obj.mandantId || obj.mandant_id);
        
        // Build detailed temperature analysis like in monitor-temperatur-mandants-objects.html
        let tempAnalysisHTML = '';
        let overallStatus = 'normal';
        let overallStatusColor = '#28a745';
        let overallStatusIcon = '✅';
        
        if (Object.keys(tempGrenzwert).length > 0) {
          // Parse each temperature sensor
          Object.keys(tempGrenzwert).forEach(key => {
            const grenzwertText = tempGrenzwert[key];
            
            // Extract temperature and determine status
            const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
            let status = 'NORMAL';
            let color = '#10b981';
            
            if (grenzwertText.includes('≤ kritisch') || grenzwertText.includes('≤ critical')) {
              status = 'CRITICAL';
              color = '#dc2626';
              overallStatus = 'critical';
              overallStatusColor = '#dc3545';
              overallStatusIcon = '🔴';
            } else if (grenzwertText.includes('> warnung') || grenzwertText.includes('> warning') ||
                       grenzwertText.includes('≥ warnung') || grenzwertText.includes('≥ warning')) {
              status = 'WARNING';
              color = '#f59e0b';
              if (overallStatus !== 'critical') {
                overallStatus = 'warning';
                overallStatusColor = '#ffc107';
                overallStatusIcon = '🟡';
              }
            }
            
            if (tempMatch) {
              tempAnalysisHTML += `${key}: ${tempMatch[1]}°C → <span style="color:${color};font-weight:bold;">${status}</span> <span style="font-size:11px;">(${grenzwertText})</span><br>`;
            }
          });
        } else {
          tempAnalysisHTML = 'Keine Temperaturdaten';
        }
        
        // Format update time
        let updateTime = 'Keine Daten';
        if (tempData.updateTime) {
          try {
            const updateDate = new Date(tempData.updateTime);
            updateTime = updateDate.toLocaleString('de-DE');
          } catch (error) {
            updateTime = tempData.updateTime;
          }
        }
        
        const row = document.createElement('tr');
        row.className = 'object-row';
        row.setAttribute('data-object', obj.name || obj.objectName);
        row.setAttribute('data-object-id', obj.id || obj.objectId);
        
        // Create detailed table row like in monitor-temperatur-mandants-objects.html
        row.innerHTML = `
          <td>
            <b>${obj.name || obj.objectName}</b><br>
            <span style="font-size:10px;color:#888;">${obj.id || obj.objectId}</span>
          </td>
          <td style="font-size: 12px;">${tempAnalysisHTML}</td>
          <td>
            <span style="color:${overallStatusColor};font-weight:bold;">${overallStatusIcon} ${overallStatus.charAt(0).toUpperCase() + overallStatus.slice(1)}</span>
          </td>
          <td style="font-size: 11px;">${updateTime}</td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to new rows
      addRowEventListeners();
    }
    
    // Update Warnings Table with tempGrenzwert analysis
    function updateWarningsTable(warningObjects) {
      const tableBody = document.querySelector('.category-section[data-category="warnings"] tbody');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      warningObjects.forEach(obj => {
        const gruppe = getMandantName(obj.mandantId || obj.mandant_id);
        const tempGrenzwert = obj.tempGrenzwert || obj.tempData?.tempGrenzwert || {};
        
        // Extract warning information from tempGrenzwert
        let warningText = 'Wartung erforderlich';
        if (Object.keys(tempGrenzwert).length > 0) {
          const warnings = [];
          Object.keys(tempGrenzwert).forEach(key => {
            const grenzwertText = tempGrenzwert[key];
            if (grenzwertText.includes('> warnung')) {
              warnings.push(`${key}: ${grenzwertText.split(' > ')[0]}`);
            }
          });
          if (warnings.length > 0) {
            warningText = warnings.join(', ');
          }
        }
        
        const warningCount = obj.warningCount || Math.floor(Math.random() * 15 + 1);
        const lastWarning = obj.lastWarningTime || 'vor ' + Math.floor(Math.random() * 120 + 5) + ' min';
        
        const row = document.createElement('tr');
        row.className = 'object-row';
        row.setAttribute('data-object', obj.name || obj.objectName);
        row.setAttribute('data-object-id', obj.id || obj.objectId);
        
        row.innerHTML = `
          <td><a href="#" class="object-link">${obj.name || obj.objectName}</a></td>
          <td>${gruppe}</td>
          <td style="font-size: 0.9em;">${warningText}</td>
          <td>${warningCount}x heute</td>
          <td>${lastWarning}</td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to new rows
      addRowEventListeners();
    }
    
    // Update Offline Table
    function updateOfflineTable(offlineObjects) {
      const tableBody = document.querySelector('.category-section[data-category="offline"] tbody');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      offlineObjects.forEach(obj => {
        const gruppe = getMandantName(obj.mandantId || obj.mandant_id);
        const offlineSince = obj.offlineSince || (Math.floor(Math.random() * 8 + 1) + 'h ' + Math.floor(Math.random() * 60) + 'min');
        const offlineReason = obj.offlineReason || (Math.random() > 0.5 ? 'Netzwerkfehler' : 'Sensor defekt');
        const lastData = obj.lastData || 'VL: ' + (Math.random() * 30 + 40).toFixed(1) + '°C';
        
        const row = document.createElement('tr');
        row.className = 'object-row';
        row.setAttribute('data-object', obj.name || obj.objectName);
        row.setAttribute('data-object-id', obj.id || obj.objectId);
        
        row.innerHTML = `
          <td><a href="#" class="object-link">${obj.name || obj.objectName}</a></td>
          <td>${gruppe}</td>
          <td>${offlineSince}</td>
          <td>${offlineReason}</td>
          <td>${lastData}</td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to new rows
      addRowEventListeners();
    }
    
    // Update count badges
    function updateCountBadges(data) {
      const criticalBadge = document.querySelector('.category-section[data-category="critical"] .count-badge');
      const warningsBadge = document.querySelector('.category-section[data-category="warnings"] .count-badge');
      const offlineBadge = document.querySelector('.category-section[data-category="offline"] .count-badge');
      const optimizedBadge = document.querySelector('.category-section[data-category="optimized"] .count-badge');
      
      if (criticalBadge) criticalBadge.textContent = data.critical.length;
      if (warningsBadge) warningsBadge.textContent = data.warnings.length;
      if (offlineBadge) offlineBadge.textContent = data.offline.length;
      if (optimizedBadge) optimizedBadge.textContent = data.optimized.length;
    }
    
    // Get mandant name by ID
    function getMandantName(mandantId) {
      if (!mandantId) return 'Unbekannt';
      
      const mandant = mandantsData.find(m => m.id === mandantId || m.mandant_id === mandantId);
      return mandant ? mandant.name : 'Mandant ' + mandantId;
    }
    
    // Add event listeners to new rows
    function addRowEventListeners() {
      const newObjectRows = document.querySelectorAll('.object-row');
      const newObjectLinks = document.querySelectorAll('.object-link');
      const newActionBtns = document.querySelectorAll('.action-btn');
      
      // Add click handlers to object rows
      newObjectRows.forEach(row => {
        row.addEventListener('click', function() {
          // Remove selection from all rows
          newObjectRows.forEach(r => r.classList.remove('selected'));
          
          // Add selection to clicked row
          this.classList.add('selected');
          
          // Load object details
          const objectName = this.getAttribute('data-object');
          const objectId = this.getAttribute('data-object-id');
          loadRealObjectDetails(objectName, objectId);
        });
      });
      
      // Add click handlers to object links
      newObjectLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const row = this.closest('.object-row');
          if (row) {
            row.click();
          }
        });
      });
      
      // Add click handlers to action buttons
      newActionBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const row = this.closest('.object-row');
          if (row) {
            row.click();
          }
        });
      });
    }
    
    // Load real object details
    function loadRealObjectDetails(objectName, objectId) {
      const objectTitle = document.getElementById('objectDetailsTitle');
      const objectSubtitle = document.getElementById('objectDetailsSubtitle');
      const noSelectionState = document.getElementById('noSelectionState');
      
      // Reset info button state if active
      const netzwaechterInfoBtn = document.getElementById('netzwaechterInfoBtn');
      if (netzwaechterInfoBtn && netzwaechterInfoBtn.classList.contains('active')) {
        netzwaechterInfoBtn.classList.remove('active');
        hideNetzwaechterInfo();
      }
      
      if (objectTitle) {
        objectTitle.innerHTML = `<i class="fas fa-cube"></i> ${objectName} - Details`;
      }
      
      // Find object in data
      const objectData = objectsData.find(obj => 
        obj.id === objectId || 
        obj.objectId === objectId || 
        obj.name === objectName
      );
      
      const tempData = tempAnalysisData.find(temp => 
        temp.objectId === objectId || 
        temp.objectName === objectName
      );
      
      if (objectData) {
        const gruppe = getMandantName(objectData.mandantId || objectData.mandant_id);
        const status = objectData.online ? 'Online' : 'Offline';
        const statusSince = objectData.online ? 'seit 2 Tagen' : 'seit ' + (Math.floor(Math.random() * 8 + 1)) + 'h';
        
        if (objectSubtitle) {
          objectSubtitle.textContent = `${objectName} (${gruppe}) • ${status} ${statusSince}`;
        }
        
        // Hide no selection state and show details
        noSelectionState.style.display = 'none';
        objectDetailsGrid.style.display = 'grid';
        
        // Update detail sections with real data
        updateRealDetailSections(objectData, tempData);
      } else {
        // Fallback to mock data
        if (objectSubtitle) {
          const gruppe = getGruppeFromObjectName(objectName);
          objectSubtitle.textContent = `${objectName} (${gruppe}) • Online seit 2 Tagen`;
        }
        
        noSelectionState.style.display = 'none';
        objectDetailsGrid.style.display = 'grid';
        updateDetailSections(objectName);
      }
    }
    
    // Update detail sections with real data
    function updateRealDetailSections(objectData, tempData) {
      // Update Grunddaten
      document.getElementById('objectId').textContent = objectData.id || objectData.objectId || '-';
      document.getElementById('objectName').textContent = objectData.name || objectData.objectName || '-';
      document.getElementById('objectGroup').textContent = getMandantName(objectData.mandantId || objectData.mandant_id);
      document.getElementById('objectLocation').textContent = objectData.location || objectData.standort || 'Unbekannt';
      document.getElementById('objectType').textContent = objectData.type || objectData.anlagentyp || 'Standard-Heizung';
      
      const status = objectData.online ? 'online' : 'offline';
      const statusClass = objectData.online ? 'status-online' : 'status-offline';
      const statusIcon = objectData.online ? 'fas fa-circle' : 'fas fa-times-circle';
      const statusText = objectData.online ? 'Online' : 'Offline';
      
      document.getElementById('objectStatus').innerHTML = `<span class="status-indicator ${statusClass}"><i class="${statusIcon}"></i> ${statusText}</span>`;
      document.getElementById('objectLastMessage').textContent = objectData.lastMessage || 'vor 2 Minuten';
      
      // Update Temperaturdaten with tempGrenzwert analysis
      if (tempData) {
        const tempGrenzwert = tempData.tempGrenzwert || {};
        let vlTemp = tempData.vlTemperature || tempData.vorlaufTemperatur || 0;
        let rlTemp = tempData.rlTemperature || tempData.ruecklaufTemperatur || 0;
        let vlLimit = tempData.vlLimit || tempData.vlGrenzwert || 0;
        let rlLimit = tempData.rlLimit || tempData.rlGrenzwert || 0;
        
        // Parse tempGrenzwert if available
        if (Object.keys(tempGrenzwert).length > 0) {
          console.log('🌡️ Using tempGrenzwert data:', tempGrenzwert);
          
          Object.keys(tempGrenzwert).forEach(key => {
            const grenzwertText = tempGrenzwert[key];
            const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
            const limitMatch = grenzwertText.match(/\((\d+\.?\d*)°C\)/);
            
            if (tempMatch) {
              if (key.includes('VL')) {
                vlTemp = parseFloat(tempMatch[1]);
                if (limitMatch) vlLimit = parseFloat(limitMatch[1]);
              } else if (key.includes('RL')) {
                rlTemp = parseFloat(tempMatch[1]);
                if (limitMatch) rlLimit = parseFloat(limitMatch[1]);
              }
            }
          });
        }
        
        // Display temperatures with color coding based on limits
        const vlColor = vlTemp > vlLimit ? '#dc2626' : vlTemp > vlLimit * 0.9 ? '#f59e0b' : '#059669';
        const rlColor = rlTemp > rlLimit ? '#dc2626' : rlTemp > rlLimit * 0.9 ? '#f59e0b' : '#059669';
        
        document.getElementById('tempVorlauf').innerHTML = `<span style="color: ${vlColor}; font-weight: 600;">${vlTemp.toFixed(1)}°C</span> <small>(Limit: ${vlLimit.toFixed(1)}°C)</small>`;
        document.getElementById('tempRuecklauf').innerHTML = `<span style="color: ${rlColor}; font-weight: 600;">${rlTemp.toFixed(1)}°C</span> <small>(Limit: ${rlLimit.toFixed(1)}°C)</small>`;
        document.getElementById('tempDifferenz').textContent = (vlTemp - rlTemp).toFixed(1) + '°C';
        document.getElementById('tempAussen').textContent = (tempData.outsideTemperature || tempData.aussenTemperatur || 0).toFixed(1) + '°C';
        document.getElementById('tempSoll').textContent = (tempData.targetTemperature || tempData.sollTemperatur || 0).toFixed(1) + '°C';
        document.getElementById('tempAbweichung').textContent = (vlTemp - (tempData.targetTemperature || 0)).toFixed(1) + '°C';
        document.getElementById('tempTrend').textContent = (tempData.trend24h || 0) > 0 ? '↗ +' + (tempData.trend24h || 0).toFixed(1) + '°C' : '↘ ' + (tempData.trend24h || 0).toFixed(1) + '°C';
      } else {
        // Fallback values
        document.getElementById('tempVorlauf').textContent = '-';
        document.getElementById('tempRuecklauf').textContent = '-';
        document.getElementById('tempDifferenz').textContent = '-';
        document.getElementById('tempAussen').textContent = '-';
        document.getElementById('tempSoll').textContent = '-';
        document.getElementById('tempAbweichung').textContent = '-';
        document.getElementById('tempTrend').textContent = '-';
      }
      
      // Update Betriebsdaten
      document.getElementById('betriebsstunden').textContent = (objectData.operatingHours || Math.floor(Math.random() * 5000 + 2000)).toLocaleString() + ' h';
      document.getElementById('brennerstarts').textContent = (objectData.burnerStarts || Math.floor(Math.random() * 20 + 5)) + ' Starts';
      document.getElementById('laufzeit').textContent = objectData.runtimeToday || Math.floor(Math.random() * 12) + 'h ' + Math.floor(Math.random() * 60) + 'min';
      document.getElementById('energieverbrauch').textContent = (objectData.energyConsumption24h || Math.floor(Math.random() * 800 + 400)).toLocaleString() + ' kWh';
      document.getElementById('pumpenleistung').textContent = (objectData.pumpPower || Math.floor(Math.random() * 40 + 60)) + '%';
      document.getElementById('letzteWartung').textContent = objectData.lastMaintenance || '2025-06-15';
      document.getElementById('naechsteWartung').textContent = (objectData.nextMaintenance || '2025-12-15') + ' (in ' + (objectData.daysUntilMaintenance || Math.floor(Math.random() * 60 + 10)) + ' Tagen)';
      document.getElementById('stoermeldungen').textContent = objectData.activeFaults === 0 || !objectData.activeFaults ? 'Keine aktiven Störungen' : objectData.activeFaults + ' aktive Störungen';
      
      // Update Grafana Content - check if Grafana mode is active
      const objectDetailsGrid = document.getElementById('objectDetailsGrid');
      if (objectDetailsGrid && objectDetailsGrid.classList.contains('grafana-mode')) {
        // If Grafana mode is active, load the iframe
        const objectId = objectData.id || objectData.objectId;
        if (objectId) {
          loadGrafanaForObject(objectId);
        }
      } else {
        // Show default Grafana content
        document.getElementById('grafanaContent').innerHTML = `
          <i class="fas fa-chart-line" style="font-size: 32px; margin-bottom: 12px; color: #3b82f6;"></i>
          <p style="margin: 0; font-weight: 600;">Grafana Dashboard - ${objectData.name || objectData.objectName}</p>
          <p style="margin: 8px 0 0 0; font-size: 12px;">
            Hier würden die spezifischen Diagramme für ${objectData.name || objectData.objectName} angezeigt werden
          </p>
        `;
      }
      
      // Update JSON Data
      const combinedData = {
        ...objectData,
        temperatureData: tempData,
        timestamp: new Date().toISOString()
      };
      document.getElementById('jsonData').textContent = JSON.stringify(combinedData, null, 2);
      
      console.log('✅ Echte Details für', objectData.name || objectData.objectName, 'geladen');
    }
    
    // Select first available object
    function selectFirstAvailableObject(data) {
      let firstRow = null;
      
      // Try to select first critical object
      if (data.critical.length > 0) {
        firstRow = document.querySelector('.category-section[data-category="critical"] .object-row');
      }
      // Otherwise try warnings
      else if (data.warnings.length > 0) {
        firstRow = document.querySelector('.category-section[data-category="warnings"] .object-row');
      }
      // Otherwise try offline
      else if (data.offline.length > 0) {
        firstRow = document.querySelector('.category-section[data-category="offline"] .object-row');
      }
      // Otherwise try optimized
      else if (data.optimized.length > 0) {
        firstRow = document.querySelector('.category-section[data-category="optimized"] .object-row');
      }
      
      if (firstRow) {
        firstRow.click();
      }
    }
    
    // Toggle temperature analysis display
    function toggleTemperatureAnalysis() {
      const toggleBtn = document.getElementById('toggleAllBtn');
      const tempContainer = document.getElementById('tempAnalysisContainer');
      const noSelectionState = document.getElementById('noSelectionState');
      const objectDetailsGrid = document.getElementById('objectDetailsGrid');
      
      if (tempContainer.classList.contains('active')) {
        // Hide temperature analysis, show normal object details
        tempContainer.classList.remove('active');
        toggleBtn.classList.remove('active');
        if (noSelectionState) noSelectionState.style.display = 'block';
        if (objectDetailsGrid) objectDetailsGrid.style.display = 'none';
      } else {
        // Show temperature analysis, hide normal object details
        tempContainer.classList.add('active');
        toggleBtn.classList.add('active');
        if (noSelectionState) noSelectionState.style.display = 'none';
        if (objectDetailsGrid) objectDetailsGrid.style.display = 'none';
        loadTemperatureAnalysis();
      }
    }
    
    // Load thresholds dynamically from frontend file
    async function loadThresholdsFromFrontend() {
      try {
        console.log('🔄 Lade Grenzwerte aus Frontend-Datei...');
        
        // Load the frontend file content
        const response = await fetch('/ws-setup-netzwaechter.html');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const content = await response.text();
        
        // Extract threshold values using regex (from applyDefaultSettings function)
        const criticalMatch = content.match(/critical:\s*\{\s*color:\s*'#dc2626',\s*vlValue:\s*(\d+),\s*rlValue:\s*(\d+)/);
        const warningMatch = content.match(/warning:\s*\{\s*color:\s*'#ffa726',\s*vlValue:\s*(\d+),\s*rlValue:\s*(\d+)/);
        const normalMatch = content.match(/normal:\s*\{\s*color:\s*'#16a34a',\s*vlValue:\s*(\d+),\s*rlValue:\s*(\d+)/);
        
        if (criticalMatch && warningMatch && normalMatch) {
          const thresholds = {
            critical: { vlValue: parseInt(criticalMatch[1]), rlValue: parseInt(criticalMatch[2]) },
            warning: { vlValue: parseInt(warningMatch[1]), rlValue: parseInt(warningMatch[2]) },
            normal: { vlValue: parseInt(normalMatch[1]), rlValue: parseInt(normalMatch[2]) }
          };
          
          console.log('✅ Grenzwerte aus Frontend geladen:', thresholds);
          
          // Update the display
          const thresholdsDisplay = document.getElementById('thresholdsDisplay');
          if (thresholdsDisplay) {
            thresholdsDisplay.innerHTML = `
              <strong>Vorlauf (VL):</strong><br>
              • Normal: > ${thresholds.normal.vlValue}°C<br>
              • Warnung: ≤ ${thresholds.warning.vlValue}°C<br>
              • Kritisch: ≤ ${thresholds.critical.vlValue}°C<br>
              <br>
              <strong>Rücklauf (RL):</strong><br>
              • Normal: ≥ ${thresholds.normal.rlValue}°C<br>
              • Warnung: > ${thresholds.warning.rlValue}°C<br>
              • Kritisch: > ${thresholds.critical.rlValue}°C<br>
              <br>
              <em style="color: #6b7280;">(Globale Standard-Grenzwerte aus ws-setup-netzwaechter.html)</em>
            `;
          }
          
          return thresholds;
        } else {
          throw new Error('Konnte Grenzwerte nicht aus Frontend-Datei extrahieren');
        }
      } catch (error) {
        console.error('❌ Fehler beim Laden der Grenzwerte:', error);
        
        // Show error in display
        const thresholdsDisplay = document.getElementById('thresholdsDisplay');
        if (thresholdsDisplay) {
          thresholdsDisplay.innerHTML = `
            <em style="color: #dc3545;">Fehler beim Laden der Grenzwerte: ${error.message}</em>
          `;
        }
        
        return null;
      }
    }
    
    // Load temperature analysis data
    async function loadTemperatureAnalysis() {
      console.log('🔄 Lade detaillierte Temperatur-Analyse...');
      
      const tempAnalysisContent = document.getElementById('tempAnalysisContent');
      if (!tempAnalysisContent) return;
      
      // Show loading state
      tempAnalysisContent.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Lade Temperatur-Analyse...</div>';
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('Kein Token gefunden');
        }
        
        // Load temperature analysis data with GLOBAL thresholds (Kategorie 0)
        const response = await fetch('/api/objects?tempAnalysisKategorie=0', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        const objects = result.success ? (result.data?.objects || result.data || []) : [];
        const thresholds = result.thresholds || {};
        
        console.log('✅ Temperatur-Analyse-Daten geladen:', objects.length, 'Objekte');
        console.log('✅ Verwendete Grenzwerte:', thresholds);
        
        // Load mandants data for overview
        const mandantsResponse = await fetch('/api/mandants?filter=withObjects', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        let mandantsData = [];
        if (mandantsResponse.ok) {
          const mandantsResult = await mandantsResponse.json();
          mandantsData = mandantsResult.success ? (mandantsResult.data || []) : [];
        }
        
        // Create mandants overview
        let mandantsOverviewHTML = '';
        if (mandantsData.length > 0) {
          console.log('🏢 Erstelle Mandanten-Übersicht...');
          
          // Filter out ID 0 (Alle Objekte Users) and collect stats for other mandants
          const filteredMandants = mandantsData.filter(mandant => {
            const mandantId = mandant.id || mandant.mandantid;
            return mandantId !== 0 && mandantId !== '0';
          });
          
          const mandantStatsHTML = await Promise.all(filteredMandants.map(async mandant => {
            const mandantId = mandant.id || mandant.mandantid;
            const mandantName = mandant.name || mandant.mandantname;
            
            try {
              // Load objects and StatusCounts from API with GLOBAL thresholds (Kategorie 0)
              const objectsResponse = await fetch(`/api/objects?tempAnalysisKategorie=0&mandantId=${mandantId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              
              if (!objectsResponse.ok) {
                throw new Error(`HTTP ${objectsResponse.status}: ${objectsResponse.statusText}`);
              }
              
              const objectsResult = await objectsResponse.json();
              if (!objectsResult.success) {
                throw new Error(objectsResult.error || 'API-Fehler');
              }
              
              const statusCounts = objectsResult.data?.statusCounts || {};
              
              // Use StatusCounts from API
              const total = statusCounts.total || 0;
              const online = statusCounts.online || 0;
              const offline = statusCounts.offline || 0;
              const warning = statusCounts.warning || 0;
              const critical = statusCounts.critical || 0;
              const normal = total - warning - critical; // Calculate normal based on other values
              
              return `ID ${mandantId}: ${mandantName} (${total} Objekte, <span style="color: #28a745;">${online} online</span>, <span style="color: #6c757d;">${offline} offline</span>, <span style="color: #28a745;">${normal} normal</span>, <span style="color: #ffc107;">${warning} warnung</span>, <span style="color: #dc3545;">${critical} kritisch</span>)`;
              
            } catch (error) {
              console.error(`❌ Fehler beim Laden der API-Daten für Mandant ${mandantId}:`, error);
              return `ID ${mandantId}: ${mandantName} (<span style="color: red;">API-Fehler: ${error.message}</span>)`;
            }
          }));
          
          mandantsOverviewHTML = `
            <div style="margin-bottom: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
              <h4 style="margin: 0 0 15px 0; color: #495057;">
                <i class="fas fa-building"></i> 
                Mandanten aus API
              </h4>
              <div style="font-family: monospace; font-size: 13px; line-height: 1.6;">
                ${mandantStatsHTML.join('<br>')}
              </div>
              <div style="margin-top: 15px; font-size: 12px; color: #6c757d;">
                <i class="fas fa-info-circle"></i> 
                Datenquelle: GET /api/mandants?filter=withObjects + /api/objects?tempAnalysisKategorie=0&mandantId={id}
              </div>
            </div>
          `;
        }
        
        // Create detailed table HTML
        let tableHTML = `
          <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
            ${mandantsOverviewHTML}
            <h4 style="margin: 0 0 15px 0; color: #495057;">
              <i class="fas fa-chart-line"></i> 
              Temperatur-KI-Analyse für ${objects.length} Objekte
            </h4>
            <div style="background: white; border-radius: 4px; overflow: hidden; border: 1px solid #dee2e6;">
              <table border="1" cellpadding="4" cellspacing="0" style="width: 100%; font-size: 12px; border-collapse: collapse; background: #fff3cd;">
                <thead>
                  <tr style="background: #f0f0f0;">
                    <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left;">ObjectName</th>
                    <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left;">Temperatur-KI-Analyse</th>
                    <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left;">Status</th>
                    <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left;">Update-Zeit</th>
                  </tr>
                </thead>
                <tbody>
        `;
        
        // Generate table rows
        objects.forEach(obj => {
          const objectName = obj.title || `Objekt ${obj.objectid}`;
          const objectId = obj.objectid;
          const nameIdCell = `<b style="color: #2563eb;">${objectName}</b><br><span style="font-size: 10px; color: #888;">${objectId}</span>`;
          
          // Build temperature analysis
          let tempAnalysisHTML = '';
          let overallStatus = 'Normal';
          let overallStatusColor = '#28a745';
          let overallStatusIcon = '✅';
          
          if (obj.tempGrenzwert && Object.keys(obj.tempGrenzwert).length > 0) {
            Object.keys(obj.tempGrenzwert).forEach(key => {
              const grenzwertText = obj.tempGrenzwert[key];
              const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
              
              let status = 'NORMAL';
              let color = '#10b981';
              
              if (grenzwertText.includes('kritisch') || grenzwertText.includes('critical')) {
                status = 'CRITICAL';
                color = '#dc2626';
                overallStatus = 'Critical';
                overallStatusColor = '#dc3545';
                overallStatusIcon = '🔴';
              } else if (grenzwertText.includes('warnung') || grenzwertText.includes('warning')) {
                status = 'WARNING';
                color = '#f59e0b';
                if (overallStatus !== 'Critical') {
                  overallStatus = 'Warning';
                  overallStatusColor = '#ffc107';
                  overallStatusIcon = '🟡';
                }
              }
              
              if (tempMatch) {
                tempAnalysisHTML += `${key}: ${tempMatch[1]}°C → <span style="color:${color};font-weight:bold;">${status}</span> <span style="font-size:11px;">(${grenzwertText})</span><br>`;
              }
            });
          } else {
            tempAnalysisHTML = 'Keine Temperaturdaten';
          }
          
          // Format update time
          let updateTime = 'Keine Daten';
          if (obj.updateTime) {
            try {
              const updateDate = new Date(obj.updateTime);
              updateTime = updateDate.toLocaleString('de-DE');
            } catch (error) {
              updateTime = obj.updateTime;
            }
          }
          
          tableHTML += `
            <tr>
              <td style="padding: 8px; border: 1px solid #ddd; vertical-align: top;">${nameIdCell}</td>
              <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; line-height: 1.4; vertical-align: top;">${tempAnalysisHTML}</td>
              <td style="padding: 8px; border: 1px solid #ddd; vertical-align: top;">
                <span style="color:${overallStatusColor};font-weight:bold;">${overallStatusIcon} ${overallStatus}</span>
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; font-size: 11px; vertical-align: top;">${updateTime}</td>
            </tr>
          `;
        });
        
        tableHTML += `
                </tbody>
              </table>
            </div>
            <div style="margin-top: 15px; font-size: 12px; color: #6c757d;">
              <i class="fas fa-info-circle"></i> 
              Datenquelle: GET /api/objects?tempAnalysisKategorie=0 | 
              Zeitstempel: ${new Date().toLocaleString('de-DE')}
            </div>
            <div style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; border-left: 4px solid #007bff;">
              <div style="font-weight: 600; color: #495057; margin-bottom: 5px;">
                <i class="fas fa-cog"></i> Grenzwerte Global (verwendet für alle Objekte):
              </div>
              <div style="font-family: monospace; font-size: 11px; color: #6c757d; line-height: 1.4;">
                <strong>Vorlauf (VL):</strong><br>
                • Normal: > ${thresholds.normal?.vl || 'N/A'}<br>
                • Warnung: ≤ ${thresholds.warning?.vl || 'N/A'}<br>
                • Kritisch: ≤ ${thresholds.critical?.vl || 'N/A'}<br>
                <br>
                <strong>Rücklauf (RL):</strong><br>
                • Normal: ≥ ${thresholds.normal?.rl || 'N/A'}<br>
                • Warnung: > ${thresholds.warning?.rl || 'N/A'}<br>
                • Kritisch: > ${thresholds.critical?.rl || 'N/A'}<br>
                <br>
                <em style="color: #6b7280;">(Globale Standard-Grenzwerte aus API - Kategorie 0)</em>
              </div>
            </div>
          </div>
        `;
        
        // Show the content in the temp analysis container
        tempAnalysisContent.innerHTML = tableHTML;
        
      } catch (error) {
        console.error('❌ Fehler beim Laden der Temperatur-Analyse:', error);
        
        // Show error message
        tempAnalysisContent.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #dc3545;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <h4>Fehler beim Laden der Temperatur-Analyse</h4>
            <p>${error.message}</p>
                          <button onclick="loadTemperatureAnalysis()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              <i class="fas fa-redo"></i> Erneut versuchen
            </button>
          </div>
        `;
      }
    }
    
    // Load critical objects from temperature analysis
    async function loadCriticalObjects() {
      const criticalContent = document.getElementById('criticalObjectsContent');
      const criticalCount = document.getElementById('criticalCount');
      
      if (!criticalContent) return;
      
      try {
        console.log('🔄 Lade kritische Anlagen...');
        
        const token = localStorage.getItem('token');
        if (!token) {
          criticalContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Kein Token vorhanden</div>';
          return;
        }
        
        // Load all objects and filter for critical ones
        const response = await fetch('/api/objects?tempAnalysisKategorie=0', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'API-Fehler');
        }
        
        const objects = result.data?.objects || [];
        const thresholds = result.thresholds || {};
        // Make objects and thresholds globally available for object details
        window.apiObjectsData = {
          objects: objects,
          thresholds: thresholds
        };
        console.log('✅ Objekte geladen:', objects.length);
        
        // Filter for critical objects (nur mit heutigem Update-Datum)
        const criticalObjects = objects.filter(obj => {
          if (!obj.tempGrenzwert || Object.keys(obj.tempGrenzwert).length === 0) {
            return false;
          }
          
          // Filtere nur Objekte mit heutigem Update-Datum
          if (!isUpdatedToday(obj.updateTime)) {
            console.log('⏭️ Kritisches Objekt übersprungen (nicht heute aktualisiert):', obj.title || obj.objectid, obj.updateTime);
            return false;
          }
          
          // Check if any temperature value is critical
          const isCritical = Object.values(obj.tempGrenzwert).some(grenzwertText => 
            grenzwertText.includes('kritisch') || grenzwertText.includes('critical')
          );
          
          if (isCritical) {
            console.log('✅ Kritisches Objekt mit heutigem Update hinzugefügt:', obj.title || obj.objectid, obj.updateTime);
          }
          
          return isCritical;
        });
        
        console.log('🔴 Kritische Objekte gefunden:', criticalObjects.length);
        
        // Store data globally for navigation
        criticalObjectsData = criticalObjects;
        
        // Update count badge
        if (criticalCount) {
          criticalCount.textContent = criticalObjects.length;
        }
        
        if (criticalObjects.length === 0) {
          criticalContent.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #28a745;">
              <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
              <p style="margin: 0; font-weight: 600;">Keine kritischen Anlagen</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Alle Anlagen sind im normalen Bereich</p>
            </div>
          `;
          return;
        }
        
        // Create table HTML
        let tableHTML = `
          <table class="category-table">
            <thead>
              <tr>
                <th>Objekt</th>
                <th>Temperatur-KI-Analyse</th>
                <th>Update-Zeit</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // Generate table rows for critical objects
        criticalObjects.forEach(obj => {
          const objectName = obj.title || `Objekt ${obj.objectid}`;
          const objectId = obj.objectid;
          
          // Build temperature analysis (compact format with network conversion)
          let tempAnalysisHTML = '';
          
          if (obj.tempGrenzwert && Object.keys(obj.tempGrenzwert).length > 0) {
            Object.keys(obj.tempGrenzwert).forEach(key => {
              const grenzwertText = obj.tempGrenzwert[key];
              
              // Extract temperature values and limits
              const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
              const limitMatch = grenzwertText.match(/(\d+\.?\d*)°C\)$/);
              
              if (tempMatch && limitMatch) {
                const currentTemp = tempMatch[1];
                const limitTemp = limitMatch[1];
                
                let status = 'NORMAL';
                let color = '#10b981';
                
                if (grenzwertText.includes('kritisch') || grenzwertText.includes('critical')) {
                  status = 'CRITICAL';
                  color = '#dc2626';
                } else if (grenzwertText.includes('warnung') || grenzwertText.includes('warning')) {
                  status = 'WARNING';
                  color = '#f59e0b';
                }
                
                // Convert Z20541 to Netz1, Z20542 to Netz2, etc.
                let networkName = key;
                if (key.includes('Z20541')) {
                  networkName = key.replace('Z20541', 'Netz1');
                } else if (key.includes('Z20542')) {
                  networkName = key.replace('Z20542', 'Netz2');
                } else if (key.includes('Z20543')) {
                  networkName = key.replace('Z20543', 'Netz3');
                } else if (key.includes('Z20544')) {
                  networkName = key.replace('Z20544', 'Netz4');
                }
                
                // Extract VL/RL from the key
                const vlRlMatch = key.match(/-([A-Z]+)$/);
                const vlRl = vlRlMatch ? vlRlMatch[1] : '';
                
                // Create compact format
                const networkBase = networkName.replace(/-[A-Z]+$/, '');
                tempAnalysisHTML += `${networkBase} ${vlRl}: <span style="color:${color};font-weight:bold;">${status}</span> (${currentTemp}°C > ${limitTemp}°C)<br>`;
              }
            });
          }
          
          // Format update time with line break
          let updateTime = 'Keine Daten';
          if (obj.updateTime) {
            try {
              const updateDate = new Date(obj.updateTime);
              const dateStr = updateDate.toLocaleDateString('de-DE');
              const timeStr = updateDate.toLocaleTimeString('de-DE');
              updateTime = `${dateStr}<br>${timeStr}`;
            } catch (error) {
              updateTime = obj.updateTime;
            }
          }
          
          tableHTML += `
            <tr class="object-row" data-object="${objectName}">
              <td style="width: calc(100% - 5px);"><a href="#" class="object-link" style="font-weight: bold;">${objectName}</a><br>${objectId}</td>
              <td style="font-family: monospace; line-height: 1.4;">${tempAnalysisHTML}</td>
              <td style="font-size: 11px; width: 80px; text-align: center;">${updateTime}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        

        
        criticalContent.innerHTML = tableHTML;
        
        // Add click listeners to the newly created critical table rows
        addTableRowClickListeners();
        
      } catch (error) {
        console.error('❌ Fehler beim Laden der kritischen Anlagen:', error);
        
        criticalContent.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #dc3545;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
            <h4>Fehler beim Laden der kritischen Anlagen</h4>
            <p>${error.message}</p>
            <button onclick="loadCriticalObjects()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              <i class="fas fa-redo"></i> Erneut versuchen
            </button>
          </div>
        `;
      }
    }
    
    // Load warning objects (similar to critical objects but filtered for warnings)
    async function loadWarningObjects() {
      const warningContent = document.getElementById('warningObjectsContent');
      const warningCount = document.getElementById('warningCount');
      
      if (!warningContent) {
        console.error('❌ Warning content container not found');
        return;
      }
      
      try {
        console.log('🟡 Loading warning objects...');
        
        // Use the same API data as critical objects
        if (!window.apiObjectsData) {
          console.log('⏳ Waiting for API data to load...');
          setTimeout(loadWarningObjects, 500);
          return;
        }
        
        // Filter objects that have warnings (but not critical) and exclude objects without update time
        const warningObjects = window.apiObjectsData.objects.filter(obj => {
          if (!obj.tempGrenzwert || Object.keys(obj.tempGrenzwert).length === 0) {
            return false;
          }
          
          // Exclude objects without update time
          if (!obj.updateTime) {
            return false;
          }
          
          // Check if any temperature value has warnings (but not critical)
          const hasWarning = Object.values(obj.tempGrenzwert).some(grenzwertText => 
            (grenzwertText.includes('warnung') || grenzwertText.includes('warning')) &&
            !(grenzwertText.includes('kritisch') || grenzwertText.includes('critical'))
          );
          
          return hasWarning;
        });
        
        console.log('🟡 Warning objects found:', warningObjects.length);
        
        // Store data globally for navigation
        warningObjectsData = warningObjects;
        
        // Update count badge
        if (warningCount) {
          warningCount.textContent = warningObjects.length;
        }
        
        if (warningObjects.length === 0) {
          warningContent.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #28a745;">
              <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
              <p style="margin: 0; font-weight: 600;">Keine Anlagen mit Warnungen</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b7280;">Alle Anlagen sind im normalen Bereich</p>
            </div>
          `;
          return;
        }
        
        // Create table HTML with scrollable tbody
        let tableHTML = `
          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
            <table class="category-table" style="width: 100%; margin: 0; height: auto; table-layout: fixed;">
              <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                <tr>
                  <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left; background: #f8f9fa; width: 25%;">Objekt</th>
                  <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left; background: #f8f9fa; width: 60%;">Temperatur-KI-Analyse</th>
                  <th style="padding: 8px; border: 1px solid #ddd; font-weight: 600; text-align: left; background: #f8f9fa; width: 15%;">Update-Zeit</th>
                </tr>
              </thead>
              <tbody style="height: auto;">
        `;
        
        // Generate table rows for all warning objects (scrollable)
        warningObjects.forEach(obj => {
          const objectName = obj.title || `Objekt ${obj.objectid}`;
          const objectId = obj.objectid;
          
          // Build temperature analysis (compact format with network conversion)
          let tempAnalysisHTML = '';
          
          if (obj.tempGrenzwert && Object.keys(obj.tempGrenzwert).length > 0) {
            Object.keys(obj.tempGrenzwert).forEach(key => {
              const grenzwertText = obj.tempGrenzwert[key];
              
              // Extract temperature values and limits
              const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
              const limitMatch = grenzwertText.match(/(\d+\.?\d*)°C\)$/);
              
              if (tempMatch && limitMatch) {
                const currentTemp = tempMatch[1];
                const limitTemp = limitMatch[1];
                
                let status = 'NORMAL';
                let color = '#10b981';
                
                if (grenzwertText.includes('kritisch') || grenzwertText.includes('critical')) {
                  status = 'CRITICAL';
                  color = '#dc2626';
                } else if (grenzwertText.includes('warnung') || grenzwertText.includes('warning')) {
                  status = 'WARNING';
                  color = '#f59e0b';
                }
                
                // Convert Z20541 to Netz1, Z20542 to Netz2, etc.
                let networkName = key;
                if (key.includes('Z20541')) {
                  networkName = key.replace('Z20541', 'Netz1');
                } else if (key.includes('Z20542')) {
                  networkName = key.replace('Z20542', 'Netz2');
                } else if (key.includes('Z20543')) {
                  networkName = key.replace('Z20543', 'Netz3');
                } else if (key.includes('Z20544')) {
                  networkName = key.replace('Z20544', 'Netz4');
                }
                
                // Extract VL/RL from the key
                const vlRlMatch = key.match(/-([A-Z]+)$/);
                const vlRl = vlRlMatch ? vlRlMatch[1] : '';
                
                // Create compact format
                const networkBase = networkName.replace(/-[A-Z]+$/, '');
                tempAnalysisHTML += `${networkBase} ${vlRl}: <span style="color:${color};font-weight:bold;">${status}</span> (${currentTemp}°C > ${limitTemp}°C)<br>`;
              }
            });
          }
          
          // Format update time with line break
          let updateTime = 'Keine Daten';
          if (obj.updateTime) {
            try {
              const updateDate = new Date(obj.updateTime);
              const dateStr = updateDate.toLocaleDateString('de-DE');
              const timeStr = updateDate.toLocaleTimeString('de-DE');
              updateTime = `${dateStr}<br>${timeStr}`;
            } catch (error) {
              updateTime = obj.updateTime;
            }
          }
          
          tableHTML += `
            <tr class="object-row" data-object="${objectName}">
              <td style="width: calc(100% - 5px);"><a href="#" class="object-link" style="font-weight: bold;">${objectName}</a><br>${objectId}</td>
              <td style="font-family: monospace; line-height: 1.4;">${tempAnalysisHTML}</td>
              <td style="font-size: 11px; width: 80px; text-align: center;">${updateTime}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
          </div>
        `;
        

        
        warningContent.innerHTML = tableHTML;
        
        // Add click listeners to the newly created warning table rows
        addTableRowClickListeners();
        
      } catch (error) {
        console.error('❌ Fehler beim Laden der Anlagen mit Warnungen:', error);
        
        warningContent.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #dc3545;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
            <h4>Fehler beim Laden der Anlagen mit Warnungen</h4>
            <p>${error.message}</p>
            <button onclick="loadWarningObjects()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              <i class="fas fa-redo"></i> Erneut versuchen
            </button>
          </div>
        `;
      }
    }
    
    // Navigation functions for critical objects
    let criticalCurrentPage = 0;
    let criticalObjectsData = [];
    
    function navigateCriticalObjects(direction) {
      if (direction === 'next' && (criticalCurrentPage + 1) * 5 < criticalObjectsData.length) {
        criticalCurrentPage++;
      } else if (direction === 'prev' && criticalCurrentPage > 0) {
        criticalCurrentPage--;
      }
      
      const startIndex = criticalCurrentPage * 5;
      const endIndex = startIndex + 5;
      const displayObjects = criticalObjectsData.slice(startIndex, endIndex);
      
               // Rebuild table with current page objects
         const criticalContent = document.getElementById('criticalObjectsContent');
         if (criticalContent) {
           let tableHTML = `
             <table class="category-table">
               <thead>
                 <tr>
                   <th>Objekt</th>
                   <th>Temperatur-KI-Analyse</th>
                   <th>Update-Zeit</th>
                 </tr>
               </thead>
               <tbody>
           `;
        
        displayObjects.forEach(obj => {
          const objectName = obj.title || `Objekt ${obj.objectid}`;
          const objectId = obj.objectid;
          
          // Build temperature analysis (same logic as before)
          let tempAnalysisHTML = '';
          if (obj.tempGrenzwert && Object.keys(obj.tempGrenzwert).length > 0) {
            Object.keys(obj.tempGrenzwert).forEach(key => {
              const grenzwertText = obj.tempGrenzwert[key];
              const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
              const limitMatch = grenzwertText.match(/(\d+\.?\d*)°C\)$/);
              
              if (tempMatch && limitMatch) {
                const currentTemp = tempMatch[1];
                const limitTemp = limitMatch[1];
                let status = 'NORMAL';
                let color = '#10b981';
                
                if (grenzwertText.includes('kritisch') || grenzwertText.includes('critical')) {
                  status = 'CRITICAL';
                  color = '#dc2626';
                } else if (grenzwertText.includes('warnung') || grenzwertText.includes('warning')) {
                  status = 'WARNING';
                  color = '#f59e0b';
                }
                
                let networkName = key;
                if (key.includes('Z20541')) networkName = key.replace('Z20541', 'Netz1');
                else if (key.includes('Z20542')) networkName = key.replace('Z20542', 'Netz2');
                else if (key.includes('Z20543')) networkName = key.replace('Z20543', 'Netz3');
                else if (key.includes('Z20544')) networkName = key.replace('Z20544', 'Netz4');
                
                const vlRlMatch = key.match(/-([A-Z]+)$/);
                const vlRl = vlRlMatch ? vlRlMatch[1] : '';
                const networkBase = networkName.replace(/-[A-Z]+$/, '');
                tempAnalysisHTML += `${networkBase} ${vlRl}: <span style="color:${color};font-weight:bold;">${status}</span> (${currentTemp}°C > ${limitTemp}°C)<br>`;
              }
            });
          }
          
          let updateTime = 'Keine Daten';
          if (obj.updateTime) {
            try {
              const updateDate = new Date(obj.updateTime);
              const dateStr = updateDate.toLocaleDateString('de-DE');
              const timeStr = updateDate.toLocaleTimeString('de-DE');
              updateTime = `${dateStr}<br>${timeStr}`;
            } catch (error) {
              updateTime = obj.updateTime;
            }
          }
          
          tableHTML += `
            <tr class="object-row" data-object="${objectName}">
              <td style="width: calc(100% - 5px);"><a href="#" class="object-link" style="font-weight: bold;">${objectName}</a><br>${objectId}</td>
              <td style="font-family: monospace; line-height: 1.4;">${tempAnalysisHTML}</td>
              <td style="font-size: 11px; width: 80px; text-align: center;">${updateTime}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        // Add navigation
        if (criticalObjectsData.length > 5) {
          const totalPages = Math.ceil(criticalObjectsData.length / 5);
          const currentPage = criticalCurrentPage + 1;
          
          tableHTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
              <button onclick="navigateCriticalObjects('prev')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; ${criticalCurrentPage === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                <i class="fas fa-chevron-left"></i> Vorherige 5
              </button>
              <span style="font-size: 12px; color: #6b7280;">
                Seite ${currentPage} von ${totalPages}
              </span>
              <button onclick="navigateCriticalObjects('next')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; ${currentPage >= totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                Nächste 5 <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          `;
        }
        
        criticalContent.innerHTML = tableHTML;
        addTableRowClickListeners();
      }
    }
    
    // Navigation functions for warning objects
    let warningCurrentPage = 0;
    let warningObjectsData = [];
    
    function navigateWarningObjects(direction) {
      if (direction === 'next' && (warningCurrentPage + 1) * 5 < warningObjectsData.length) {
        warningCurrentPage++;
      } else if (direction === 'prev' && warningCurrentPage > 0) {
        warningCurrentPage--;
      }
      
      const startIndex = warningCurrentPage * 5;
      const endIndex = startIndex + 5;
      const displayObjects = warningObjectsData.slice(startIndex, endIndex);
      
             // Rebuild table with current page objects
       const warningContent = document.getElementById('warningObjectsContent');
       if (warningContent) {
         let tableHTML = `
           <table class="category-table">
             <thead>
               <tr>
                 <th>Objekt</th>
                 <th>Temperatur-KI-Analyse</th>
                 <th>Update-Zeit</th>
               </tr>
             </thead>
             <tbody>
         `;
        
        displayObjects.forEach(obj => {
          const objectName = obj.title || `Objekt ${obj.objectid}`;
          const objectId = obj.objectid;
          
          // Build temperature analysis (same logic as before)
          let tempAnalysisHTML = '';
          if (obj.tempGrenzwert && Object.keys(obj.tempGrenzwert).length > 0) {
            Object.keys(obj.tempGrenzwert).forEach(key => {
              const grenzwertText = obj.tempGrenzwert[key];
              const tempMatch = grenzwertText.match(/(\d+\.?\d*)°C/);
              const limitMatch = grenzwertText.match(/(\d+\.?\d*)°C\)$/);
              
              if (tempMatch && limitMatch) {
                const currentTemp = tempMatch[1];
                const limitTemp = limitMatch[1];
                let status = 'NORMAL';
                let color = '#10b981';
                
                if (grenzwertText.includes('kritisch') || grenzwertText.includes('critical')) {
                  status = 'CRITICAL';
                  color = '#dc2626';
                } else if (grenzwertText.includes('warnung') || grenzwertText.includes('warning')) {
                  status = 'WARNING';
                  color = '#f59e0b';
                }
                
                let networkName = key;
                if (key.includes('Z20541')) networkName = key.replace('Z20541', 'Netz1');
                else if (key.includes('Z20542')) networkName = key.replace('Z20542', 'Netz2');
                else if (key.includes('Z20543')) networkName = key.replace('Z20543', 'Netz3');
                else if (key.includes('Z20544')) networkName = key.replace('Z20544', 'Netz4');
                
                const vlRlMatch = key.match(/-([A-Z]+)$/);
                const vlRl = vlRlMatch ? vlRlMatch[1] : '';
                const networkBase = networkName.replace(/-[A-Z]+$/, '');
                tempAnalysisHTML += `${networkBase} ${vlRl}: <span style="color:${color};font-weight:bold;">${status}</span> (${currentTemp}°C > ${limitTemp}°C)<br>`;
              }
            });
          }
          
          let updateTime = 'Keine Daten';
          if (obj.updateTime) {
            try {
              const updateDate = new Date(obj.updateTime);
              const dateStr = updateDate.toLocaleDateString('de-DE');
              const timeStr = updateDate.toLocaleTimeString('de-DE');
              updateTime = `${dateStr}<br>${timeStr}`;
            } catch (error) {
              updateTime = obj.updateTime;
            }
          }
          
          tableHTML += `
            <tr class="object-row" data-object="${objectName}">
              <td style="width: calc(100% - 5px);"><a href="#" class="object-link" style="font-weight: bold;">${objectName}</a><br>${objectId}</td>
              <td style="font-family: monospace; line-height: 1.4;">${tempAnalysisHTML}</td>
              <td style="font-size: 11px; width: 80px; text-align: center;">${updateTime}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        // Add navigation
        if (warningObjectsData.length > 5) {
          const totalPages = Math.ceil(warningObjectsData.length / 5);
          const currentPage = warningCurrentPage + 1;
          
          tableHTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
              <button onclick="navigateWarningObjects('prev')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; ${warningCurrentPage === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                <i class="fas fa-chevron-left"></i> Vorherige 5
              </button>
              <span style="font-size: 12px; color: #6b7280;">
                Seite ${currentPage} von ${totalPages}
              </span>
              <button onclick="navigateWarningObjects('next')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; ${currentPage >= totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                Nächste 5 <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          `;
        }
        
        warningContent.innerHTML = tableHTML;
        addTableRowClickListeners();
      }
    }
    
    // Add click functionality to all table rows
    function addTableRowClickListeners() {
      // Add click listeners to all object-row elements
      const objectRows = document.querySelectorAll('.object-row');
      objectRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function() {
          const objectName = this.getAttribute('data-object');
          if (objectName) {
            console.log('🎯 Table row clicked:', objectName);
            
            // Try to find objectId from critical objects data if available
            let objectId = null;
            if (window.apiObjectsData && window.apiObjectsData.objects) {
              const objectData = window.apiObjectsData.objects.find(obj => 
                (obj.title || obj.name || obj.objectName || 'Objekt ' + (obj.objectid || obj.id)) === objectName
              );
              if (objectData) {
                objectId = objectData.objectid || objectData.id;
              }
            }
            
            // Use loadObjectDetails like other tables
            loadObjectDetails(objectName);
            
            // Check if this is a critical or warning object
            const isCriticalObject = this.closest('.category-section[data-category="critical"]') !== null;
            const isWarningObject = this.closest('.category-section[data-category="warnings"]') !== null;
            
            if (isCriticalObject || isWarningObject) {
              const objectType = isCriticalObject ? 'critical' : 'warning';
              console.log(`🎯 ${objectType} object clicked - activating Grafana mode automatically`);
              
              // Activate Grafana mode automatically for critical and warning objects
              const objectDetailsGrid = document.getElementById('objectDetailsGrid');
              const grafanaBtn = document.getElementById('grafanaBtn');
              
              // Reset all modes
              objectDetailsGrid.classList.remove('grafana-mode', 'json-mode');
              document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
              
              // Activate Grafana mode
              objectDetailsGrid.classList.add('grafana-mode');
              if (grafanaBtn) {
                grafanaBtn.classList.add('active');
              }
              
              // Load Grafana with the correct object ID
              if (objectId) {
                console.log(`🎯 Loading Grafana for ${objectType} object:`, objectName, 'ID:', objectId);
                loadGrafanaForObject(objectId);
              } else {
                console.log(`🎯 No objectId found for ${objectType} object:`, objectName);
                // Try to extract objectId from objectName (fallback)
                const extractedId = objectName.split(' ')[0];
                if (extractedId && extractedId !== objectName) {
                  console.log('🎯 Using extracted objectId:', extractedId);
                  loadGrafanaForObject(extractedId);
                }
              }
            } else {
              // For non-critical objects, check if Grafana mode is already active
              const objectDetailsGrid = document.getElementById('objectDetailsGrid');
              const isGrafanaMode = objectDetailsGrid && objectDetailsGrid.classList.contains('grafana-mode');
              
              if (isGrafanaMode) {
                if (objectId) {
                  console.log('🎯 Grafana mode active - updating iframe for object:', objectName, 'ID:', objectId);
                  loadGrafanaForObject(objectId);
                } else {
                  console.log('🎯 Grafana mode active - but no objectId found for:', objectName);
                  // Try to extract objectId from objectName (fallback)
                  const extractedId = objectName.split(' ')[0];
                  if (extractedId && extractedId !== objectName) {
                    console.log('🎯 Using extracted objectId:', extractedId);
                    loadGrafanaForObject(extractedId);
                  }
                }
              }
            }
            
            // Scroll to object details section
            const objectDetailsSection = document.querySelector('.object-details-section');
            if (objectDetailsSection) {
              objectDetailsSection.scrollIntoView({ behavior: 'smooth' });
            }
          }
        });
        
        // Add hover effects
        row.addEventListener('mouseover', function() {
          this.style.backgroundColor = '#f8f9fa';
        });
        
        row.addEventListener('mouseout', function() {
          this.style.backgroundColor = '';
        });
      });
    }
    
    // Initialize: Load API data
    loadAPIData();
    
    // Load critical objects after a short delay
    setTimeout(() => {
      loadCriticalObjects();
    }, 1000);
    
    // Load warning objects after a short delay
    setTimeout(() => {
      loadWarningObjects();
    }, 1500);
    
    // Add table row click listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      addTableRowClickListeners();
    });

    function loadKpiWohnungswirtschaft() {
      // Hier später echte API-Logik
      setTimeout(() => {
        document.getElementById('kpiWohnungswirtschaftValue').textContent = '87%';
        document.getElementById('kpiWohnungswirtschaftSubtext').textContent = 'Durchschnittlicher Effizienzgrad';
      }, 800);
    }
    document.addEventListener('DOMContentLoaded', loadKpiWohnungswirtschaft);

    function loadKpiNetzwaechterAlarme() {
      // Hier später echte API-Logik
      setTimeout(() => {
        document.getElementById('kpiNetzwaechterAlarmeValue').textContent = '5';
        document.getElementById('kpiNetzwaechterAlarmeSubtext').innerHTML = 'Kritische & präventive Alarme<br><a href="#criticalObjectsContent" style="color:#dc2626;font-weight:600;text-decoration:underline;cursor:pointer;">Zu den kritischen Anlagen</a>';
      }, 800);
    }
    document.addEventListener('DOMContentLoaded', loadKpiNetzwaechterAlarme);
  </script>
</body>
</html> 